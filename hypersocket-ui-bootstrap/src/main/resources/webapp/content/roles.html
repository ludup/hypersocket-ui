<div id="contentRoles">
	<div class="modal" id="addRoleForm" tabindex="-1" role="dialog" dialog-for="contentRoles">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group lb-row">
						<label class="col-md-3 control-label" localize="role.name"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control"
								 id="name" maxlength="" name="name" value="">
							<div>
								<span class="lb-help-block form-text text-muted" localize="role.name.info"></span>
							</div>
						</div>
					</div>
					<div id="roleProperties"></div>
					<div id="tabRolePrincipals" style="overflow:auto">
							<div class="col-12">
								<label class="col-md-3 control-label" localize="allUsers.label"></label>
								<div class="propertyValue col-md-9">
									<div id="allUsers"></div>
									<div>
										<span class="lb-help-block form-text text-muted" localize="role.allUsers.info"></span>
									</div>
								</div>
							</div>
							<div class="col-12 hideUsers">
								<label class="col-md-3 control-label" localize="users.label"></label>
								<div class="propertyValue col-md-9">
									<div id="tabUsersContent"></div>
									<div>
										<span class="lb-help-block form-text text-muted" localize="role.users.info"></span>
									</div>
								</div>
							</div>
							<div class="col-12 hideUsers">
								<label class="col-md-3 control-label" localize="groups.label"></label>
								<div class="propertyValue col-md-9">
									<div id="tabGroupsContent"></div>
									<div>
										<span class="lb-help-block form-text text-muted" localize="role.groups.info"></span>
									</div>
								</div>
							</div>
					</div>
					
					<div id="tabRolePermissions">
						<div class="col-12">
								<label class="col-md-3 control-label" localize="allPerms.label"></label>
								<div class="propertyValue col-md-9">
									<div id="allPerms"></div>
									<div>
										<span class="lb-help-block form-text text-muted" localize="role.allPerms.info"></span>
									</div>
								</div>
							</div>
						<div class="col-12 hidePerms">
							<label class="col-md-3 control-label" localize="permissions.label"></label>
							<div class="propertyValue col-md-9">
								<div id="tabPermissionsContent"></div>
								<div>
									<span class="lb-help-block form-text text-muted" localize="role.permissions.info"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="tabRoleRealms">
						<div class="col-12">
							<label class="col-md-3 control-label" localize="allRealms.label"></label>
							<div class="propertyValue col-md-9">
								<div id="allRealms"></div>
								<div>
									<span class="lb-help-block form-text text-muted" localize="role.allRealms.info"></span>
								</div>
							</div>
						</div>
						<div class="col-12 hideRealms">
							<label class="col-md-3 control-label" localize="realms.label"></label>
								<div class="propertyValue col-md-9">
									<div id="tabRealmsContent"></div>
									<div>
										<span class="lb-help-block form-text text-muted" localize="role.realms.info"></span>
									</div>
								</div>
						</div>
					</div>
					<input name="roleId" id="roleId" type="hidden" class="formInput" />

				</div>
				<div class="modal-footer">
				</div>
			</div>
		</div>
	</div>

</div>
<script type="text/javascript">

	$(document).ready(function() {
		$('#contentRoles').localize();

		$('#allUsers').switchInput({
			changed: function(widget) {
				if(widget.getValue()) {
					$('.hideUsers').hide();
					$('.hideRealms').hide();
				} else {
					$('.hideUsers').show();
					$('.hideRealms').show();
				}
			}
		});
		
		$('#allPerms').switchInput({
			changed: function(widget) {
				if(widget.getValue()) {
					$('.hidePerms').hide();
				} else {
					$('.hidePerms').show();
				}
			}
		});
		
		$('#allRealms').switchInput({
			changed: function(widget) {
				if(widget.getValue()) {
					$('.hideRealms').hide();
				} else {
					$('.hideRealms').show();
				}
			}
		});
		
		$('#tabRealmsContent').multipleSelect({
			nameIsResourceKey: false,
			nameAttr : 'name',
			valueAttr: 'id',
			selectedIsObjectList: true,
			selected: [],
			disabled: !currentMenu.canUpdate,
			selectAllIfEmpty: false,
			url: 'realms/delegatable',
			getUrlData: function(data) {
				return data.resources;
			}
		});
		
		$('#tabGroupsContent').multipleSearchInput({
			nameAttr : 'principalName',
			valueAttr: 'id',
			selectedIsObjectList: true,
			disabled: !currentMenu.canUpdate,
			url: 'currentRealm/groups/table'
		});


		$('#tabUsersContent').multipleSearchInput({
			nameAttr : 'principalName',
			valueAttr: 'id',
			selectedIsObjectList: true,
			disabled: !currentMenu.canUpdate,
			url: 'currentRealm/users/table'
		});

		$('#contentRoles').ajaxResourcePage(
				{
				id: 'Role',
				tableUrl : "roles/table",
				title: getResource('roles.title'),
				infoHtml: getResource('roles.infoHtml'),
				icon: 'fa-user-md',
				resourceUrl : "roles/role",
				deleteResourcesUrl : 'roles/bulk',
				fields : [{ name: "name",
							 sortable: true}, {
							 name: "type",
							 sortable: true}
				],
				searchFields: [{
					name: "name"
				}, {
					name: "type",
					renderOptions: function(element, refresh) {
						element.textDropdown({
							valueAttr: 'name',
							url: 'enum/com.hypersocket.permissions.RoleType/USER,GROUP/',
							changed: function() {
								refresh();
							}
						});	
					}
				}], 
				resourceKey : 'role',
				canCreate: currentMenu.canCreate,
				canUpdate: currentMenu.canUpdate,
				canDelete: currentMenu.canDelete,
				checkbox : true,
				validate : function() {
					if ($('#name').val() == '') {
						showError("error.nameRequired");
						return false;
					}
					if(!$('#roleProperties').validateProperties()) {
						showError("error.correctValidationErrors");
						return false;
					}
					
					return true;
				},
				clearDialog : function(create) {
					$('#name').val('');
					$('#roleId').val('');
					$('#tabUsersContent').multipleSearchInput();
					$('#tabGroupsContent').multipleSearchInput();
					$('#tabRealmsContent').multipleSelect();
					$('#tabPermissionsContent').multipleSelect({
						nameIsResourceKey : true,
						nameAttr : 'resourceKey',
						selectedIsObjectList: true,
						selected: [],
						disabled: !currentMenu.canUpdate,
						selectAllIfEmpty: false,
						url: 'permissions/list',
						getUrlData: function(data) {
							return data.permissions;
						}
					});
					
					$('#tabGroupsContent').widget().enable();
					$('#tabUsersContent').widget().enable();
					$('#allUsers').widget().enable();
					$('#allPerms').widget().enable();
					$('#allRealms').widget().enable();
					$('#allUsers').widget().setValue(false);
					$('#allPerms').widget().setValue(false);
					$('#allRealms').widget().setValue(false);
					
					if(create) {
						var r = [];
						r.push(currentRealm);
						$('#tabRealmsContent').multipleSelect({
	 						selected : r,
	 						nameIsResourceKey: false,
	 						disabled: false,
	 						selectAllIfEmpty: false
	 					});
						
						$('#roleProperties').propertyPage({
							url : 'roles/template',
							showButtons : false,
							useTemplates : true,
							displayMode: 'admin',
							canUpdate : currentMenu.canUpdate,
							additionalTabs : [ {
								id : "tabRolePrincipals",
								name : getResource("label.principals")
							},{
								id : "tabRolePermissions",
								name : getResource("label.permissions")
							},{
								id : "tabRoleRealms",
								name : getResource("label.realms")
							} ]
						});
					}

				},
				createResource : function() {
					role = new Object();
					role.id = $('#roleId').val();
					role.name = $('#name').val();
					role.users = $('#tabUsersContent').widget().getValue();
					role.groups = $('#tabGroupsContent').widget().getValue();
					role.permissions = $('#tabPermissionsContent').widget().getValue();
					role.realms = $('#tabRealmsContent').widget().getValue();
					role.allUsers = $('#allUsers').widget().getValue();
					role.allPerms = $('#allPerms').widget().getValue();
					role.allRealms = $('#allRealms').widget().getValue();
					
					$('#roleProperties').saveProperties(true,
							function(items) {
								role.properties = items;
					});
					return role;
				},
				resourceCreated : function(resource) {
					
				},
				deleted : function(resource) {
					
				},
				displayResource : function(resource, readOnly) {
					$('#roleId').val(resource.id);
					$('#name').val(resource.name);
					$('#name').attr('disabled', readOnly);
					
					$('#allUsers').widget().setValue(resource.allUsers);
					if(resource.system) {
						$('#allUsers').widget().disable();
					} else {
						$('#allUsers').widget().enable();
					}
					
					$('#allPerms').widget().setValue(resource.allPermissions);
					if(resource.system) {
						$('#allPerms').widget().disable();
					} else {
						$('#allPerms').widget().enable();
					}
					
					$('#allRealms').widget().setValue(resource.allRealms);
					if(resource.system) {
						$('#allRealms').widget().disable();
					} else {
						$('#allRealms').widget().enable();
					}
					
					getJSON('roles/principals/' + resource.id, null, function(data) {
						var users = new Array();
						var groups = new Array();
						$.each(data.resources, function(idx, obj) {
							if(obj.type == 'USER') {
								users.push(obj);
							} else if(obj.type == 'GROUP') {
								groups.push(obj);
							}
						});
	 	 			  	$('#tabUsersContent').multipleSearchInput({
	 						selected : users,
	 						disabled: resource.personalRole || resource.allUsers || readOnly
	 					});
	 					$('#tabGroupsContent').multipleSearchInput({
	 						selected : groups,
	 						disabled: resource.personalRole || resource.allUsers || readOnly
	 					});
					});
					
					getJSON('roles/permissions/' + resource.id, null, function(data) {
						$('#tabPermissionsContent').multipleSelect({
	 						selected : data.resources,
	 						disabled: resource.allPermissions || readOnly,
	 						selectAllIfEmpty: resource.allPermissions
	 					});
					});

					getJSON('roles/realms/' + resource.id, null, function(data) {
						$('#tabRealmsContent').multipleSelect({
	 						selected : data.resources,
	 						nameIsResourceKey: false,
	 						disabled: readOnly,
	 						selectAllIfEmpty: false
	 					});
					});
					
 					$('#roleProperties').propertyPage({
 						url : 'roles/properties/' + resource.id,
 						showButtons : false,
 						useTemplates : true,
 						displayMode: 'admin',
 						canUpdate : currentMenu.canUpdate,
 						additionalTabs : [ {
 							id : "tabRolePrincipals",
 							name : getResource("label.principals")
 						},{
 							id : "tabRolePermissions",
 							name : getResource("label.permissions")
 						},{
 							id : "tabRoleRealms",
 							name : getResource("label.realms")
 						} ]
 					});
				},
				complete: function() {
					loadComplete();
				}
			});
	
	});
</script>