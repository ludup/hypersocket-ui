<div id="contentRoles">
	<div class="modal" id="addRoleForm" tabindex="-1" role="dialog" dialog-for="contentRoles">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="role.name"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control"
								placeholder="" id="name" maxlength="" name="name" value="">
							<div>
								<span class="help-block" localize="role.name.info"></span>
							</div>
						</div>
					</div>
					<div id="roleProperties"></div>
					<div id="tabRoleUsers"><div id="tabUsersContent" class="col-xs-12"></div></div>
					<div id="tabRoleGroups"><div id="tabGroupsContent" class="col-xs-12"></div></div>
					<div id="tabRolePermissions"><div id="tabPermissionsContent" class="col-xs-12"></div></div>
					<input name="roleId" id="roleId" type="hidden" class="formInput" />

				</div>
				<div class="modal-footer">
				</div>
			</div>
		</div>
	</div>

</div>
<script type="text/javascript">

	$(document).ready(function() {
		$('#contentRoles').localize();

		$('#tabPermissionsContent').multipleSelect({
			nameIsResourceKey : true,
			nameAttr : 'resourceKey',
			selectedIsObjectList: true,
			disabled: !currentMenu.canUpdate,
			url: 'permissions/list',
			getUrlData: function(data) {
				return data.permissions;
			}
		});


		$('#tabGroupsContent').multipleSearchInput({
			nameAttr : 'principalName',
			valueAttr: 'id',
			selectedIsObjectList: true,
			disabled: !currentMenu.canUpdate,
			url: 'currentRealm/groups/table'
		});


		$('#tabUsersContent').multipleSearchInput({
			nameAttr : 'principalName',
			valueAttr: 'id',
			selectedIsObjectList: true,
			disabled: !currentMenu.canUpdate,
			url: 'currentRealm/users/table'
		});
	
		
		
		
		$('#contentRoles').ajaxResourcePage(
				{
				id: 'Role',
				tableUrl : "roles/table",
				title: getResource('roles.title'),
				infoHtml: getResource('roles.infoHtml'),
				icon: 'fa-user-md',
				resourceUrl : "roles/role",
				deleteResourcesUrl : 'roles/bulk',
				fields : [{ name: "name",
							 sortable: true}, {
							 name: "type",
							 sortable: true}
				],
				searchFields: [{
					name: "name"
				}, {
					name: "type",
					renderOptions: function(element, refresh) {
						element.textDropdown({
							valueAttr: 'name',
							url: 'enum/com.hypersocket.permissions.RoleType/',
							changed: function() {
								refresh();
							}
						});	
					}
				}], 
				resourceKey : 'role',
				canCreate: currentMenu.canCreate,
				canUpdate: currentMenu.canUpdate,
				canDelete: currentMenu.canDelete,
				checkbox : true,
				validate : function() {
					if ($('#name').val() == '') {
						showError("error.nameRequired");
						return false;
					}
					if(!$('#roleProperties').validateProperties()) {
						showError("error.correctValidationErrors");
						return false;
					}
					
					return true;
				},
				clearDialog : function(create) {
					$('#name').val('');
					$('#roleId').val('');
					$('#tabUsersContent').multipleSearchInput();
					$('#tabGroupsContent').multipleSearchInput();
					$('#tabPermissionsContent').multipleSelect();
					
					$('#tabGroupsContent').widget().enable();
					$('#tabUsersContent').widget().enable();
					if(create) {
						$('#roleProperties').propertyPage({
							url : 'roles/template',
							showButtons : false,
							useTemplates : true,
							displayMode: 'admin',
							canUpdate : currentMenu.canUpdate,
							additionalTabs : [ {
								id : "tabRoleUsers",
								name : getResource("label.users")
							},{
								id : "tabRoleGroups",
								name : getResource("label.groups")
							},{
								id : "tabRolePermissions",
								name : getResource("label.permissions")
							} ]
						});
					}

				},
				createResource : function() {
					role = new Object();
					role.id = $('#roleId').val();
					role.name = $('#name').val();
					role.users = $('#tabUsersContent').widget().getValue();
					role.groups = $('#tabGroupsContent').widget().getValue();
					role.permissions = $('#tabPermissionsContent').widget().getValue();
					
					$('#roleProperties').saveProperties(true,
							function(items) {
								role.properties = items;
					});
					return role;
				},
				resourceCreated : function(resource) {
					
				},
				deleted : function(resource) {
					
				},
				displayResource : function(resource, readOnly) {
					$('#roleId').val(resource.id);
					$('#name').val(resource.name);
					$('#name').attr('disabled', readOnly);
					var users = new Array();
					var groups = new Array();
					$.each(resource.principals, function(idx, obj) {
						if(obj.type == 'USER') {
							users.push(obj);
						} else if(obj.type == 'GROUP') {
							groups.push(obj);
						}
					});
 	 			  	$('#tabUsersContent').multipleSearchInput({
 						selected : users,
 						disabled: resource.personalRole || resource.allUsers || readOnly
 					});
 					$('#tabGroupsContent').multipleSearchInput({
 						selected : groups,
 						disabled: resource.personalRole || resource.allUsers || readOnly
 					});
 					$('#tabPermissionsContent').multipleSelect({
 						selected : resource.permissions,
 						disabled: resource.allPermissions || readOnly,
 						selectAllIfEmpty: resource.allPermissions
 					});
 					
 					$('#roleProperties').propertyPage({
 						url : 'roles/properties/' + resource.id,
 						showButtons : false,
 						useTemplates : true,
 						displayMode: 'admin',
 						canUpdate : currentMenu.canUpdate,
 						additionalTabs : [ {
 							id : "tabRoleUsers",
 							name : getResource("label.users")
 						},{
 							id : "tabRoleGroups",
 							name : getResource("label.groups")
 						},{
 							id : "tabRolePermissions",
 							name : getResource("label.permissions")
 						} ]
 					});
				},
				complete: function() {
					loadComplete();
				}
			});
	
	});
</script>