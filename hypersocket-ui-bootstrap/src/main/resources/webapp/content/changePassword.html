<div id="changePassword" class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h2>
						<i class="far fa-lock"></i><span class="ml-2 break"
							localize="changePassword.page"></span><br>
					</h2>
					<ul id="schemePills" class="nav nav-tabs">
					</ul>
				</div>
                <div class="container"> 
					<div class="row">
						<div class="col-md-7">
							<div class="modal-body">
								<div id="currentPasswordSection" class="propertyItem form-group lb-row">
									<label id="passwordLabel" class="col-md-3 control-label"
										localize="currentPassword.label"></label>
									<div class="propertyValue col-md-9">
										<input type="password" class="form-control"
											 id="password" maxlength="" name="password"
											value="">
										<div>
											<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="currentPassword.info"></span><br>
										</div>
									</div>
								</div>
									<div class="propertyItem form-group lb-row">
										<label id="newpasswordLabel" class="col-md-3 control-label"
											localize="newPassword.label"></label>
										<div class="propertyValue col-md-9">
											<input type="password" class="form-control"
												 id="newPassword" maxlength="" name="newPassword"
												value="">
											<div>
												<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="newPassword.info"></span><br>
											</div>
										</div>
									</div>
									<div class="propertyItem form-group lb-row">
										<label id="confirmPasswordLabel" class="col-md-3 control-label"
											localize="confirmPassword.label"></label>
										<div class="propertyValue col-md-9">
											<input type="password" class="form-control"
												 id="confirmPassword" maxlength=""
												name="confirmPassword" value="">
											<div>
												<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="confirmPassword.info"></span><br>
											</div>
										</div>
									</div>
							</div>
						</div>
						<div id="passwordPolicyHolder" class="col-md-5">
							<div id="passwordPolicy" class="alert alert-info m-3"></div>
						</div>
					</div>
			     </div>
				<div class="panel-footer p-2" bg-light border-top>
					<button id="changeButton" class="btn btn-primary">
						<i class="far fa-save"></i><span localize="changePassword"></span>
					</button>
				</div>
			</div>
		</div>
		
	</div>
</div>
<script src="${uiPath}/js/passwordPolicy.js"></script>
<script type="text/javascript">
	legacyjQueryReadyFix(function() {
		
		let showCurrentPassword = null;
		
		getJSON('configuration/values/password.onChangePromptCurrent/', null, function(data) {
			
			let showCurrentPasswordValue = data.resource['password.onChangePromptCurrent'];
			
			showCurrentPassword = showCurrentPasswordValue === "true";

			if (!showCurrentPassword) {
				$("#currentPasswordSection").hide();
			}
			
			$('#changePassword').localize();
			
			$('#passwordPolicy').passwordPolicy({
				policy: 'currentPrincipal',
				passwordElement:$('#newPassword'), 
				confirmElement: $('#confirmPassword'),
				showGenerator: true,
				alternativeUi: true,
				columnStyle: 'col-md-12'
			});
			
			loadComplete();
		});
		
		function validate() {
			if (showCurrentPassword && $('#password').val()=='') {
				showError(getResource("changepassword.nocurrentpassword.error"));
				return false;
			}
			if ($('#newPassword').val()=='') {
				showError(getResource("changepassword.nonewpassword.error"));
				return false;
			}
			if($('#newPassword').val()!=$('#confirmPassword').val()){
				showError(getResource('changepassword.passwordMismatched.error'));
	    		return false;
	   		}
			return true;
		}
		
		$("#changeButton").click(function() {
			if(validate()){
				
				startSpin($('#changeButton i'), 'fa-spinner');
				
				var formData = new FormData();
				formData.append('oldPassword', showCurrentPassword ? $('#password').val() : null);
				formData.append('newPassword',$('#newPassword').val());
				doAjax({
					type : 'POST',
					url : basePath +'/api/currentRealm/user/changePassword/',  
					dataType : 'json',
					cache : false,
					contentType : false,
					processData : false,
					data : formData,
					success : function(data) {
						 if (data.success) {
							 showSuccess(data.message);
							$('#confirmPassword').val('');
							$('#newPassword').val('');
							$('#password').val('');
						 }else{
							 showError(data.message); 
						 }
					},
					error : function(jqXHR,textStatus,errorThrown) {
						showError(errorThrown);
					},
					complete: function() {
						stopSpin($('#changeButton i'), 'fa-save');
					} 
				});
			}
		});
		
		
	});
	
      
</script>