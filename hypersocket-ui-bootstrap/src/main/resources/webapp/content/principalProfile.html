<div data-id="principalProfile" class="extendedTabContent">
	<div data-id="principalProfileContainer" class="container-fluid">
		<div class="row">
			<div class="col-md-6">
				<div data-id="profileTab"></div>
			</div>
			<div class="col-md-6">
				<div data-id="credentialsTab"></div>
			</div>
		</div>
		<div data-id="syncProfileOptionsContainer">
		</div>
		<div data-id="profileTabActions" class="extendedTabContentActions"></div>
	</div>
</div>
<script type="text/javascript">
	legacyjQueryReadyFix(function() {

		var tabRefresh = undefined;
		
		var loadProfile = function(resource, data, readOnly, tab, authSchemes) {
			
			if (!tabRefresh && tab) {
				tabRefresh = tab.data('refresh');
			}
			
			var _$ = function(jq) {
				return $(jq + '_' + resource.id);
			}

			_$('#principalProfile .col-md-6').find('.row').remove();
			_$('#syncProfileOptionsContainer').empty();
			var el = _$('#profileTab');
			el.empty();
			var el2 = _$('#credentialsTab');
			el2.empty();
			getJSON('tabs/principalProfile/userProfile/' + resource.id, null, function(data) {
				if (data.resource) {
					if (data.resource.state === 'COMPLETE') {
						el.append('<div class="row"><span class="col-sm-12 h4 pl-0"><i class="far fa-star text-success"></i> <span localize="completedProfile.text"></span></span></div>');
						el.append('<div class="row"><span localize="profile.completed"></span>&nbsp; <span>' + new Date(data.resource.completed).format('ddd, dd mmm yyyy HH:MM') + '</span></div>');
					} else if (data.resource.state === 'NOT_REQUIRED') {
						el.append('<div class="row"><span class="col-sm-12 h4 pl-0"><i class="far fa-star"></i> <span localize="notRequiredProfile.text"></span></span></div>');
					} else if (data.resource.state === 'PARTIALLY_COMPLETE') {
						el.append('<div class="row"><span class="col-sm-12 h4 pl-0"><i class="far fa-star-half-stroke text-warning"></i> <span localize="partialProfile.text"></span></span></div>');
					} else {
						el.append('<div class="row"><span class="col-sm-12 h4 pl-0"><i class="far fa-star-exclamation text-danger"></i> <span localize="incompleteProfile.text"></span></span></div>');
					}

					el2.append('<h4 localize="credentials.text"></h4>');
					
					if (data.resource.credentials && data.resource.credentials.length > 0) {
						
						$.each(data.resource.credentials, function(idx, creds) {
							creds.iconClass = creds.iconClass || 'fa-question';
							if (authSchemes.indexOf(creds.resourceKey) === -1) {
								warn("The creds with data " + JSON.stringify(creds) + " not present in auth scheme list.");
								return;
							}
							el2.append('<div class="row no-gutters">' + '<span class="col-sm-5"><i class="mr-2 ' + (creds.iconClass.indexOf('fab') == -1 ? 'far ' : '') + ' ' + creds.iconClass + '"></i>' + '<label localize="' + creds.resourceKey + '"></label></span><span class="col-sm-4">' + creds.state + '</span><span id="parent_container_tab_action_' + creds.resourceKey + '_' + data.resource.id + '" class="col-sm-3"></span></div>');
						});
					} else {
						el2.append('<div><span class="font-weight-bold" localize="text.noData"></span></div>');
					}
					

					_$('#syncProfileOptionsContainer').append('<div class="row"><div class="col-sm-12"><a  id="force_' + resource.id + '" href="#"><span localize="forceSync.text"></span></a> | <a id="reset_' + resource.id + '" href="#"><span localize="resetProfile.label"></span></a></div></div>');

					var force = _$('#force');
					force.click(function(e) {
						e.preventDefault();
						getJSON('currentRealm/forceProfileSync/' + resource.id, null, function(data) {
							if (data.success) {
								showSuccess(getResource("profile.synchronized"));
								loadProfile(resource);
								tabRefresh();
							} else {
								showError(data.message);
							}
						});
					});

					var reset = _$('#reset');
					reset.click(function(e) {
						e.preventDefault();
						bootbox.confirm(getResource('resetProfile.text').format(cleanValue(resource.principalName)), function(result) {
							if (result) {
								getJSON('currentRealm/resetProfile/' + resource.id, null, function(data) {
									if (data.success) {
										showSuccess(getResource("profile.reset"));
										loadProfile(resource);
										tabRefresh();
									} else {
										showError(data.message);
									}
								});
							}
						});
					});

				} else {

					el.append('<div class="row"><span class="col-sm-12 h4"><i class="far fa-star text-danger"></i> <span localize="noProfile.text"></span></span></div>');
			    	el.append('<div class="row"><div class="col-sm-12"><a  id="generate_' + resource.id + '" href="#"><span localize="generate.text"></span></a></div></div>');
			    	
			    	var force =  _$('#generate');
			    	force.click(function(e) {
			    		e.preventDefault();
			    		getJSON('currentRealm/forceProfileSync/' + resource.id, null, function(data) {
			    			if(data.success) {
			    				showSuccess(getResource("profile.synchronized"));
			    				loadProfile(resource);
			    				tabRefresh();
			    			} else {
			    				showError(data.message);
			    			}
			    		});
			    	});
				}

				_$('#principalProfile').localize();
			});
		};
		$('.extendedTabContent').data('initPage', loadProfile);

	});

</script>