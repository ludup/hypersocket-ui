<div id="contentTriggers">
</div>
<script type="text/javascript">
	var triggerList = [];
	var resourceList = [];
	var triggerMap = [];
	var selectedId;
	legacyjQueryReadyFix(function() {
				$('#contentTriggers').localize();
				$('#contentTrigger').localize();
				
				var templateName = $('#templateName').textInput();
				$('#templateName').hide();
				
				$('#contentTriggers').load(uiPath + '/content/triggers-modal.html', function() {
						
				var resourcePage = $('#contentTriggers').ajaxResourcePage(
							{
								id : "Trigger",
								tableUrl : "triggers/table",
								title: getResource("triggers.label"),
								infoHtml: getResource('triggers.infoHtml'),
								icon: 'fa-bolt',
								resourceUrl : "triggers/trigger",
								deleteResourcesUrl : "triggers/bulk",
								importUrl: 'triggers/import',
								exportUrl: 'triggers/export',
								fields : [ {
									name : "name"
								}],
								resourceKey : "trigger",
								canCreate: currentMenu.canCreate,
								canUpdate: currentMenu.canUpdate,
								canDelete: currentMenu.canDelete,
								checkbox : true,
								showCreate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null, 0);
								},
								showUpdate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null, 0);
								},
								validate : function() {
									return $(document).data('triggerModalCallback').validate();
								},
								clearDialog : function(create) {
									$(document).data('triggerModalCallback').clearDialog(create);
								},
								createResource : function() {
									return $(document).data('triggerModalCallback').createResource();
								},
								displayResource : function(resource) {
									if(resource.isRoot) {
										$(document).data('triggerModalCallback').loadParent(null, null, 0);
										$(document).data('triggerModalCallback').displayResource(resource);
									} else {
										getJSON('triggers/parentEvents/' + resource.id, null, function(data) {
											getJSON('triggers/trigger/' + resource.parentId, null, function(parent) {
												$(document).data('triggerModalCallback').loadParent(parent, data.resources, 0);
												$(document).data('triggerModalCallback').displayResource(resource);	
											});
										});
// 										$(document).data('triggerModalCallback').loadParent(resource.parent, null, 0);
// 										$(document).data('triggerModalCallback').displayResource(resource);
									}
								},
								complete : function() {
									loadComplete();
								},
								resourceUpdated: function(resource) {
									$('._jsPlumb_connector').remove();
									$('#schemeArea' + resource.id).find('.triggerDraggable').empty();
									resourcePage.refresh();
								},
								detailView: true,
								detailFormatter: function(index, resource, element) {
									// Here element is the jquery object where you can render the view and resource is the table rows resource.
									element.append(
											'<div id="contentTrigger' + resource.id + '" class="panel panel-default" style="display: none;">'
										+	'<div class="spacer20px"></div>'
										+	'	<div class="lb-row">'
										+	'		<div class="col-md-12" id="schemeArea' + resource.id + '">'	
										+	'			<div id="triggerTasks' + resource.id + '" style="overflow: auto; height: 300px">'		
										+	'				<div id="rootTrigger' + resource.id + '" class="triggerShape trigger-same-row" style="position: absolute; left: 50px; top: 50px;">'			
										+	'					<span id="rootEvent' + resource.id + '" class="triggerContent"></span>'				
										+	'				</div>'			
										+	'			</div>'		
										+	'			<div class="spacer20px"></div>'		
										+	'		</div>'	
										+	'		<div class="col-md-3" id="triggerArea' + resource.id + '">'
										+	'			<div id="triggerIcons' + resource.id + '"></div>'				
										+	'		</div>'
										+	'	</div>'
										+	'</div>');
									var jsPlumbInstance = jsPlumb.getInstance();
									jsPlumbInstance.setContainer($('#schemeArea' + resource.id));
									renderDiagram(resource, resourcePage, resource.id, jsPlumbInstance);
								}
								
							});
				});

			});
	
	function renderDiagram(trigger, resourcePage, rootId, jsPlumbInstance) {
		//jsPlumb.empty($('#triggerView' + rootId));
		triggerList = [];
		triggerMap = [];
		if(trigger) {

			$('#contentTrigger' + trigger.id).show();
			$('#rootEvent' + trigger.id).text(getResource(trigger.event));

        	triggerList.push('triggerDiagram_' + trigger.id);
        	triggerMap[trigger.id] = trigger;
        	createTriggerList(trigger.childTriggers);
        	var top = 25;
        	var left = 200;
        	getState(triggerList, false, function(data){
        		resourceList = data.resources;
        		addTask(trigger, null, top+50, left+50, rootId, jsPlumbInstance);
        		jsPlumbInstance.connect({
    	            source: 'rootTrigger' + trigger.id,
    	            target:"triggerDiagram_" + trigger.id,
    	            connector: 'Flowchart',
    	            anchor: "AutoDefault",
    	            endpoint:"Blank",
    	            detachable:false,
    	            overlays:[["Arrow", {location: 1}]]
    	        });
				jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));				
				$('#triggerDiagram_' + trigger.id).draggable({
			        stop: function(e){
			            if($(this).data('trigger')){
			            	var preferences = {};
			            	state = new Object();
			            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
			            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
				            if(preferences.leftpx < 0) {
				            	preferences.leftpx = 0;
				            }
				            if(preferences.top < 0) {
				            	preferences.top = 0;
				            }
				            
				            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
			            }
			        },
					containment: 'parent'
			    });
				
				$('.addIcon').off('click');
				$('.addIcon').on('click', function(e) {
					e.preventDefault();
					var trigger = $(this).closest('.triggerShape').data('trigger');
					getJSON('triggers/parentEvents/' + trigger.id, null, function(data) {
							$(document).data('triggerModalCallback').loadParent(trigger, data.resources, 0);
							$('div[dialog-for="contentTriggers"]').resourceDialog('create', { 
								resourceCreated: function(resource) {
									renderDiagram(resource, resourcePage, rootId, jsPlumbInstance);
								}
							});
					});
				});
				
				$('.editIcon').off('click');
				$('.editIcon').on('click', function(e) {
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					var trigger = triggerShape.data('trigger');
					$('div[dialog-for="contentTriggers"]').resourceDialog('edit', trigger); 
				});
				  
				$('.deleteTriggerIcon').off('click');
				$('.deleteTriggerIcon').on('click', function(e) {
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					var trigger = triggerShape.data('trigger');

					if(!trigger.isRoot) {
						bootbox.confirm(getResource("confirm.deleteTriggerItem").format(cleanValue(trigger.name)), function(result) {
							  if(result) {
								  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
										if(data.success) {
											showSuccess(data.message);
											renderDiagram(data.resource, resourcePage, rootId, jsPlumbInstance);
											resourcePage.refresh();
										} else {
											showError(data.message)
										}
									});
							  }
						}); 
					} else {
						bootbox.confirm(getResource("confirm.deleteTrigger").format(cleanValue(trigger.name)), function(result) {
							  if(result) {
								  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
										if(data.success) {
											showSuccess(data.message);
											renderDiagram(null, resourcePage, rootId, jsPlumbInstance);
											resourcePage.refresh();
										} else {
											showError(data.message)
										}
									});
							  }
						}); 
					}
					
				});
        	});
        	
		} else {
			$('#contentTrigger' + trigger.id).hide();
		}
	}
	
	function createTriggerList(childTriggers){
		$.each(childTriggers, function(index, triggerValue){
			triggerList.push('triggerDiagram_' + triggerValue.id);
			triggerMap[triggerValue.id] = triggerValue;
			if(triggerValue.childTriggers && triggerValue.childTriggers.length){
				createTriggerList(triggerValue.childTriggers);
			}
		});
	}
	
	function addTask(trigger, parent, top, left, rootId, jsPlumbInstance) {
		var triggerClass = "blueTrigger";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerClass = "redTrigger";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerClass = "yellowTrigger";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerClass = "greenTrigger";
		}
		$.each(resourceList, function(index, value){
			var preferences = JSON.parse(value.preferences);
			if(value.name == 'triggerDiagram_' + trigger.id){
				top = preferences.top;
				left = preferences.leftpx;
				return false;
			}
		});
		
		$('#triggerTasks' + rootId).append(
					"<div style='top: " + top + "px; left: " + left + "px; position: absolute;' class='triggerShape triggerDraggable " + triggerClass + " trigger-same-row' id='triggerDiagram_" + trigger.id + "'>"
				+	"	<div class='triggerContent'>"
				+	"		<span class='triggerText'>"	+ trigger.name + "</span>"
				+	"		<a data-trigger='"+ trigger.id + "' class='addIcon triggerIcon' href=''>"
				+	"			<i class='far fa-plus-circle'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='editIcon triggerIcon' href=''>"
				+	"			<i class='far fa-edit'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='deleteTriggerIcon triggerIcon' href=''>"
				+	"			<i class='far fa-trash'></i>"
				+	"		</a>"
				+	"	</div>"
				+	"</div>");
		
		$('#triggerDiagram_' + trigger.id).data('trigger', trigger);
		$('#triggerDiagram_' + trigger.id).data('parent', parent);
		if(parent) {
			jsPlumbInstance.connect({
	            source:"triggerDiagram_" + parent.id,
	            target:"triggerDiagram_" + trigger.id,
	            connector: 'Flowchart',
	            anchor: "AutoDefault",
	            endpoint:"Blank",
	            detachable:false,
	            overlays:[["Arrow", {location: 1}]]
	        });
			
			jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));
			$('#triggerDiagram_' + trigger.id).draggable({
		        stop: function(e){
		            if($(this).data('trigger')){
		            	var preferences = {};
		            	state = new Object();
		            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
		            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
			            if(preferences.leftpx < 0) {
			            	preferences.leftpx = 0;
			            }
			            if(preferences.top < 0) {
			            	preferences.top = 0;
			            }
			            
			            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
		            }
		        },
		        containment: 'parent'
		    });
		}
		
		top+= 50;
		$.each(trigger.childTriggers, function(idx, childTrigger) {
			left+=175;
			addTask(childTrigger, trigger, top, left, rootId, jsPlumbInstance);
		});
        
        
	}
</script>
<script src="${uiPath}/js/jsplumb.js"></script>