<!-- 
	Replace any Trigger or Triggers with Capitalized name of your resources e.g. Application or Applications
	Replace any trigger or triggers with lower case name of your resources e.g. application or applications
 -->

<div id="contentTriggers">
</div>
<div id="searchTriggers">
	<div class="modal" id="searchTriggersForm" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header lb-modal-header-text-reverse">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title" localize="text.searchTemplates"></h4>
				</div>
				<div class="modal-body">
					<div id="searchDialog" class="searchDialog">
						<div id="searchHeader" class="row">
							<div class="col-6"></div>
							<label class="col-2" localize="text.search"></label>
							<input class="col-4" type="text" id="searchInput">
						</div>
						<div id="searchResults" class="row">
						
						</div>
						<div id="pages">
						
						</div>
					</div>
					<div id="templateName"></div>
	
					<div id="templateVariables" class="searchDialog">
					
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="addTemplate" class="btn btn-primary"><i class="fad fa-save"></i>Next</button>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- <div id="drawing" style="height: 1000px"></div> -->
<script type="text/javascript">
	var triggerList = [];
	var resourceList = [];
	var triggerMap = [];
	var selectedId;
	function populateResults(results) {
		var count = 0;
		$('#searchResults').empty();
		var currentElement = $('#searchResults').append('<div class="row"></div>');
		$.each(results, function(idx, obj) {
			if(count > 0 && ((count % 5) == 0)) {
				currentElement = $('#searchResults').append('<div class="row"></div>');
			}
			currentElement.append('<div id="template' + obj.id + '" class="col-2 template"><a href="#"><div class="row"><img width="100px" src="'
					+ basePath
					+ '/api/triggers/image/' 
					+ obj.templateLogo 
					+ '"></div><div class="row"><span>' 
					+ obj.name
					+ '</span></div></a></div>');
			$('#template' + obj.id).data('template', obj);
			count++;
		});
	
		if(count < 10) {
			for(var i=count;i<10;i++) {
				if(count > 0 && ((count % 5) == 0)) {
					currentElement = $('#searchResults').append('<div class="row"></div>');
				}
				currentElement.append('<div class="col-2 template"></div>');
				count++;
			}
		}
	
		$('.template a').off('click');
		$('.template a').on('click', function(e) {
			e.preventDefault();
			$('.selectedTemplate').removeClass('selectedTemplate');
			$(this).parent().addClass('selectedTemplate');
			$('#addTemplate').attr('disabled', false);
		});
	}
	legacyjQueryReadyFix(function() {
				$('#contentTriggers').localize();
				$('#contentTrigger').localize();
				$('#searchTriggers').localize();
				
				var templateName = $('#templateName').textInput();
				$('#templateName').hide();
				
				$('#contentTriggers').load(uiPath + '/content/triggers-modal.html', function() {
						
				var resourcePage = $('#contentTriggers').ajaxResourcePage(
							{
								id : "Trigger",
								tableUrl : "triggers/table",
								title: getResource("triggers.label"),
								infoHtml: getResource('triggers.infoHtml'),
								icon: 'fa-light-switch',
								resourceUrl : "triggers/trigger",
								deleteResourcesUrl : "triggers/bulk",
								importUrl: 'triggers/import',
								exportUrl: 'triggers/export',
								fields : [ {
									name : "name"
								}],
								resourceKey : "trigger",
								canCreate: currentMenu.canCreate,
								canUpdate: currentMenu.canUpdate,
								canDelete: currentMenu.canDelete,
								checkbox : true,
								additionalButtons: [{ 
									resourceKey: 'triggerSearchOnline',
									buttonClass: 'btn-primary',
									icon: 'fa-search',
									action: function(callback) {
										$('#searchInput').val('');
										$('#templateVariables').hide();
										$('#searchDialog').show();
										$('#searchResults').empty();
										$('#pages').empty();
										$('#addTemplate').children('i').removeClass('fa-spin fa-spinner');
										$('#addTemplate').children('i').addClass('fa-save');
										$('#pages').append('<div id="searchPages"></div>');
										
										var iDisplayStart = 0;
										var params = new Array();
										params['sSearch'] = $('#searchInput').val();
										params['iDisplayStart'] = iDisplayStart;
										params['iDisplayLength'] = 10;
										
										$('#addTemplate').attr('disabled', true);
										$('#addTemplate').off('click');
										page = 0;
										$('#addTemplate').on('click', function(e) {
											removeMessage();
											var template = $('.selectedTemplate').data('template');
											switch(page) {
												case 0:
												{
													$('#searchDialog').hide();
													if(templateName.getValue().trim()=='') {
														templateName.setValue(template.name);
													}
													var variables = splitFix(template.variables);
													if(variables.length > 0) {
														$('#templateVariables').empty();
														$('#templateVariables').append('<div class="row"><p style="text-align: center; margin-bottom: 20px"><strong>' + getResource('info.additionalDetails') + '</strong></p></div>');
														$.each(variables, function(idx, obj) {
															var items = obj.split('=');
															var label = decodeURIComponent(items[0]);
															var info = decodeURIComponent(items[1]);
															info = replaceAll(info, '<', "&lt;")
															info = replaceAll(info, '>', '&gt;');
															var id = label.replace(/\s/g, "");
															var variable = id.substring(0,1).toLowerCase() + id.substring(1);
															$('#templateVariables').append('<div class="propertyItem form-group lb-row">'
																	+ '<label class="col-3 control-label">' + label + '</label>'
																	+ '<div class="propertyValue col-9"><div id="variable' + id + '" data-variable="' + variable + '" + class="variable"></div><div>'
																	+ '<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1">' + info + '</span></div></div></div>');
														
															$('#variable' + id).textInput();
														
														});
														page = 1;
														$('#templateVariables').show();
													} else {
														page = 2;
														$('#addTemplate').trigger('click');
													}
													break;
												}
												case 1:
												{
													var valid = true;
													$('.variable').each(function(idx) {
														if($(this).widget().getValue().trim()=='') {
															valid = false;
														}
													});
													
													if(!valid) {
														showError('error.pleaseProvideAllDetails');
														return;
													}
												
													page = 2;
													$('#addTemplate').trigger('click');
													break;
												}
												case 2:
												{
													$('#addTemplate').children('i').removeClass('fa-save');
													$('#addTemplate').children('i').addClass('fa-spin fa-spinner');
									
													var data = template.script;
		 											
													var name = templateName.getValue();

													data = replaceAll(data,'${templateName}', name);
													$('.variable').each(function(idx) {
														var variable = $(this).data('variable');
														data = replaceAll(data, '${' + variable + '}', $(this).widget().getValue());
														data = replaceAll(data, encodeURIComponent('${' + variable + '}'), encodeURIComponent($(this).widget().getValue()));
													});
													
													postFORM(basePath + '/api/triggers/script', $.param({ script: data }), function(data) {
														$('#addTemplate').children('i').removeClass('fa-spin fa-spinner');
														$('#addTemplate').children('i').addClass('fa-save');
														if(data.success) {
															loadResources(function() {
																resourcePage.refresh();
																$('#searchTriggersForm').modal('hide');
																showInformation(getResource('info.createdTrigger').format(data.resource.name));
															});
														} else {
															showError(data.message);
														}   
													});
		 											break;	
												}
																					
												default:
												{
													alert('Invaild page!');
												}

											}
										});
										
										$('#searchInput').change(function() {
											getJSON('triggers/search?iDisplayStart=0&iDisplayLength=10&sSearch=' + $('#searchInput').val(), null, function(data) {
												
												$('#pages').empty();
												$('#pages').append('<div id="searchPages"></div>');
												$('#searchResults').empty();
												
												if(data.rows.length > 0) {
												
													populateResults(data.rows);
													
													// init bootpag
											        $('#searchPages').bootpag({
											            total: data.total <= 10 ? 1 : (data.total / 10) + (data.total % 10 != 0 ? 1 : 0),
											            page: 1,
											            maxVisible: 10
											        }).on("page", function(event, num){
														if(num) {
												        	getJSON('triggers/search?iDisplayStart=' + ((num-1) * 10) + '&iDisplayLength=10&sSearch=' + $('#searchInput').val(), null, function(data) {
												        		populateResults(data.rows);
															});
														}
											        	
											        });
												} else {
													$('#searchResults').append('<p style="width:100%; text-align: center; padding-top:50px;">' + getResource('info.triggersNoResults').format($('#searchInput').val()));
												}
												
											}, function(xmlRequest) {
												log('Failed to get online templates: ' + xmlRequest.status);
												showError('error.failedToSearchTemplates');
											});	
										});
										
										$('#searchInput').trigger('change');
										$('#searchTriggersForm').modal({
											  backdrop: 'static',
											  keyboard: false
										});
										$('#searchTriggersForm').off('hidden.bs.modal');
										$('#searchTriggersForm').on('hidden.bs.modal', function () {
												 removeMessage();
										});
										$('#searchTriggersForm').modal('show');
									}
								}],
								showCreate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null, 0);
								},
								showUpdate: function() {
									$(document).data('triggerModalCallback').loadParent(null, null, 0);
								},
								validate : function() {
									return $(document).data('triggerModalCallback').validate();
								},
								clearDialog : function(create) {
									$(document).data('triggerModalCallback').clearDialog(create);
								},
								createResource : function() {
									return $(document).data('triggerModalCallback').createResource();
								},
								displayResource : function(resource) {
									if(resource.isRoot) {
										$(document).data('triggerModalCallback').loadParent(null, null, 0);
										$(document).data('triggerModalCallback').displayResource(resource);
									} else {
										getJSON('triggers/parentEvents/' + resource.id, null, function(data) {
											getJSON('triggers/trigger/' + resource.parentId, null, function(parent) {
												$(document).data('triggerModalCallback').loadParent(parent, data.resources, 0);
												$(document).data('triggerModalCallback').displayResource(resource);	
											});
										});
// 										$(document).data('triggerModalCallback').loadParent(resource.parent, null, 0);
// 										$(document).data('triggerModalCallback').displayResource(resource);
									}
								},
								complete : function() {
									loadComplete();
								},
								resourceUpdated: function(resource) {
									$('._jsPlumb_connector').remove();
									$('#schemeArea' + resource.id).find('.triggerDraggable').empty();
									resourcePage.refresh();
								},
								detailView: true,
								detailFormatter: function(index, resource, element) {
									// Here element is the jquery object where you can render the view and resource is the table rows resource.
									element.append(
											'<div id="contentTrigger' + resource.id + '" class="panel panel-default" style="display: none;">'
										+	'<div class="spacer20px"></div>'
										+	'	<div class="lb-row">'
										+	'		<div class="col-md-12" id="schemeArea' + resource.id + '">'	
										+	'			<div id="triggerTasks' + resource.id + '" style="overflow: auto; height: 300px">'		
										+	'				<div id="rootTrigger' + resource.id + '" class="triggerShape trigger-same-row" style="position: absolute; left: 50px; top: 50px;">'			
										+	'					<span id="rootEvent' + resource.id + '" class="triggerContent"></span>'				
										+	'				</div>'			
										+	'			</div>'		
										+	'			<div class="spacer20px"></div>'		
										+	'		</div>'	
										+	'		<div class="col-md-3" id="triggerArea' + resource.id + '">'
										+	'			<div id="triggerIcons' + resource.id + '"></div>'				
										+	'		</div>'
										+	'	</div>'
										+	'</div>');
									var jsPlumbInstance = jsPlumb.getInstance();
									jsPlumbInstance.setContainer($('#schemeArea' + resource.id));
									renderDiagram(resource, resourcePage, resource.id, jsPlumbInstance);
								}
								
							});
				});

			});
	
	function renderDiagram(trigger, resourcePage, rootId, jsPlumbInstance) {
		//jsPlumb.empty($('#triggerView' + rootId));
		triggerList = [];
		triggerMap = [];
		if(trigger) {

			$('#contentTrigger' + trigger.id).show();
			$('#rootEvent' + trigger.id).text(getResource(trigger.event));

        	triggerList.push('triggerDiagram_' + trigger.id);
        	triggerMap[trigger.id] = trigger;
        	createTriggerList(trigger.childTriggers);
        	var top = 25;
        	var left = 200;
        	getState(triggerList, false, function(data){
        		resourceList = data.resources;
        		addTask(trigger, null, top+50, left+50, rootId, jsPlumbInstance);
        		jsPlumbInstance.connect({
    	            source: 'rootTrigger' + trigger.id,
    	            target:"triggerDiagram_" + trigger.id,
    	            connector: 'Flowchart',
    	            anchor: "AutoDefault",
    	            endpoint:"Blank",
    	            detachable:false,
    	            overlays:[["Arrow", {location: 1}]]
    	        });
				jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));				
				$('#triggerDiagram_' + trigger.id).draggable({
			        stop: function(e){
			            if($(this).data('trigger')){
			            	var preferences = {};
			            	state = new Object();
			            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
			            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
				            if(preferences.leftpx < 0) {
				            	preferences.leftpx = 0;
				            }
				            if(preferences.top < 0) {
				            	preferences.top = 0;
				            }
				            
				            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
			            }
			        },
					containment: 'parent'
			    });
				
				$('.addIcon').off('click');
				$('.addIcon').on('click', function(e) {
					e.preventDefault();
					var trigger = $(this).closest('.triggerShape').data('trigger');
					getJSON('triggers/parentEvents/' + trigger.id, null, function(data) {
							$(document).data('triggerModalCallback').loadParent(trigger, data.resources, 0);
							$('div[dialog-for="contentTriggers"]').resourceDialog('create', { 
								resourceCreated: function(resource) {
									renderDiagram(resource, resourcePage, rootId, jsPlumbInstance);
								}
							});
					});
				});
				
				$('.editIcon').off('click');
				$('.editIcon').on('click', function(e) {
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					var trigger = triggerShape.data('trigger');
					$('div[dialog-for="contentTriggers"]').resourceDialog('edit', trigger); 
				});
				  
				$('.deleteTriggerIcon').off('click');
				$('.deleteTriggerIcon').on('click', function(e) {
					e.preventDefault();
					var triggerShape = $(this).closest('.triggerShape');
					var trigger = triggerShape.data('trigger');

					if(!trigger.isRoot) {
						bootbox.confirm(getResource("confirm.deleteTriggerItem").format(he.escape(stripNull(trigger.name))), function(result) {
							  if(result) {
								  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
										if(data.success) {
											showSuccess(data.message);
											renderDiagram(data.resource, resourcePage, rootId, jsPlumbInstance);
											resourcePage.refresh();
										} else {
											showError(data.message)
										}
									});
							  }
						}); 
					} else {
						bootbox.confirm(getResource("confirm.deleteTrigger").format(he.escape(stripNull(trigger.name))), function(result) {
							  if(result) {
								  deleteJSON('triggers/trigger/' + trigger.id, null, function(data) {
										if(data.success) {
											showSuccess(data.message);
											renderDiagram(null, resourcePage, rootId, jsPlumbInstance);
											resourcePage.refresh();
										} else {
											showError(data.message)
										}
									});
							  }
						}); 
					}
					
				});
        	});
        	
		} else {
			$('#contentTrigger' + trigger.id).hide();
		}
	}
	
	function createTriggerList(childTriggers){
		$.each(childTriggers, function(index, triggerValue){
			triggerList.push('triggerDiagram_' + triggerValue.id);
			triggerMap[triggerValue.id] = triggerValue;
			if(triggerValue.childTriggers && triggerValue.childTriggers.length){
				createTriggerList(triggerValue.childTriggers);
			}
		});
	}
	
	function addTask(trigger, parent, top, left, rootId, jsPlumbInstance) {
		var triggerClass = "blueTrigger";
		if(trigger.result == 'EVENT_FAILURE') {
			triggerClass = "redTrigger";
		}else if(trigger.result == 'EVENT_WARNING') {
			triggerClass = "yellowTrigger";
		} else if(trigger.result == 'EVENT_SUCCESS') {
			triggerClass = "greenTrigger";
		}
		$.each(resourceList, function(index, value){
			var preferences = JSON.parse(value.preferences);
			if(value.name == 'triggerDiagram_' + trigger.id){
				top = preferences.top;
				left = preferences.leftpx;
				return false;
			}
		});
		
		$('#triggerTasks' + rootId).append(
					"<div style='top: " + top + "px; left: " + left + "px; position: absolute;' class='triggerShape triggerDraggable " + triggerClass + " trigger-same-row' id='triggerDiagram_" + trigger.id + "'>"
				+	"	<div class='triggerContent'>"
				+	"		<span class='triggerText'>"	+ trigger.name + "</span>"
				+	"		<a data-trigger='"+ trigger.id + "' class='addIcon triggerIcon' href=''>"
				+	"			<i class='fad fa-plus-circle'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='editIcon triggerIcon' href=''>"
				+	"			<i class='fad fa-edit'></i>"
				+	"		</a>"
				+	"		<a data-trigger='" + trigger.id + "' class='deleteTriggerIcon triggerIcon' href=''>"
				+	"			<i class='fad fa-trash'></i>"
				+	"		</a>"
				+	"	</div>"
				+	"</div>");
		
		$('#triggerDiagram_' + trigger.id).data('trigger', trigger);
		$('#triggerDiagram_' + trigger.id).data('parent', parent);
		if(parent) {
			jsPlumbInstance.connect({
	            source:"triggerDiagram_" + parent.id,
	            target:"triggerDiagram_" + trigger.id,
	            connector: 'Flowchart',
	            anchor: "AutoDefault",
	            endpoint:"Blank",
	            detachable:false,
	            overlays:[["Arrow", {location: 1}]]
	        });
			
			jsPlumbInstance.draggable($('#triggerDiagram_' + trigger.id));
			$('#triggerDiagram_' + trigger.id).draggable({
		        stop: function(e){
		            if($(this).data('trigger')){
		            	var preferences = {};
		            	state = new Object();
		            	preferences.top = Math.round($(this).css('top').substring(0, $(this).css('top').length - 2));
		            	preferences.leftpx = Math.round($(this).css('left').substring(0, $(this).css('left').length - 2));
			            if(preferences.leftpx < 0) {
			            	preferences.leftpx = 0;
			            }
			            if(preferences.top < 0) {
			            	preferences.top = 0;
			            }
			            
			            saveState('triggerDiagram_' + $(this).data('trigger').id, preferences, false);
		            }
		        },
		        containment: 'parent'
		    });
		}
		
		top+= 50;
		$.each(trigger.childTriggers, function(idx, childTrigger) {
			left+=175;
			addTask(childTrigger, trigger, top, left, rootId, jsPlumbInstance);
		});
        
        
	}
</script>
<script src="${uiPath}/js/jsplumb.js"></script>