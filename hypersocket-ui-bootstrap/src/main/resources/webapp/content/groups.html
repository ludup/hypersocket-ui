<div id="contentGroups">
	<!-- Modal -->
	<div class="modal" id="addGroupForm" tabindex="-1" role="dialog" dialog-for="contentGroups">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="group.name"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control"
								placeholder="" id="groupName" maxlength="" name="name" value="">
							<div>
								<span class="help-block" localize="group.name.info"></span>
							</div>
						</div>
					</div>
					<div id="groupProperties" class="tabContent"></div>
					<div id="tabGroupUsers" class="tabContent"></div>
					<div id="tabGroupGroups" class="tabContent"></div>
					<input type="hidden" name="groupId" id="groupId"/>

				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

	$(document).ready(function() {
		
		var apiUrl =  'currentRealm';
		var disableDecoration = false;
		var groupRealm = $(document).data('groupRealm');
		var title = getResource('groups.title');
		var buttons = [];
		if(groupRealm) {
			apiUrl = 'ownerRealm/' + groupRealm.id;
			disableDecoration = true;
			buttons.push({ 
				resourceKey: 'backButton',
				buttonClass: 'btn-danger',
				icon: 'fa-step-backward',
				action: function(callback) {
					window.location = $(document).data('accounts.returnTo');
				}
			});
			title = getResource('ownerRealm.groups.title').format(groupRealm.name);
		} else {
			groupRealm = currentRealm;
		}
		
		$(document).data('groupRealm', null);
		
		$('#contentGroups').localize();

		$('#tabGroupUsers').multipleSearchInput({
			nameAttr : 'principalName',
			selectedIsObjectList: false,
			valueAttr: 'id',
			url: apiUrl + '/users/table'
		});
		
		$('#tabGroupGroups').multipleSearchInput({
			nameAttr : 'principalName',
			selectedIsObjectList: false,
			valueAttr: 'id',
			url: apiUrl + '/groups/table'
		});
	
		
		$('#contentGroups').ajaxResourcePage(
				{
				id: 'Group',
				tableUrl : apiUrl + "/groups/table",
				title: title,
				icon: 'fa-users',
				resourceUrl : apiUrl + "/group",
				deleteResourcesUrl : apiUrl + "/bulk/groups",
				fields : [ { name: "name"} ],
				resourceKey : 'group',
				disableDecoration: disableDecoration,
				canCreate: currentMenu.canCreate,
				canUpdate: currentMenu.canUpdate,
				canDelete: currentMenu.canDelete,
				additionalButtons: buttons,
				checkbox : true,
				validate : function() {
					if ($('#groupName').val() == '') {
						showError("error.nameRequired");
						return false;
					}
					if(!$('#groupProperties').validateProperties()) {
						showError("error.correctValidationErrors");
						return false;
					}
					return true;
				},
				clearDialog : function(create) {
					$('#groupName').val('');
					$('#groupId').val('');
					$('#tabGroupUsers').multipleSearchInput();
					$('#groupProperties').parent().append($('#tabGroupUsers').detach());
					$('#groupProperties').parent().append($('#tabGroupGroups').detach());
					$('#groupProperties').empty();
					
					if(create) {
						$('#groupProperties').propertyPage({
							url : apiUrl + '/group/template/' + groupRealm.resourceCategory,
							showButtons : false,
							useTemplates : true,
							canUpdate : currentMenu.canUpdate,
							urlProcessor: function(url) {
								return url.replace('$' + '{realmApi}', apiUrl);
							},
							additionalTabs : [ {
								id : "tabGroupUsers",
								name : getResource("label.users")
							},
							{
								id : "tabGroupGroups",
								name : getResource("label.groups")
							}]
						});
					}
					
				},
				createResource : function() {
					group = new Object();
					group.id = $('#groupId').val();
					group.name = $('#groupName').val();
					group.users = $('#tabGroupUsers').widget().getValue();
					group.groups = $('#tabGroupGroups').widget().getValue();
					
					$('#groupProperties').saveProperties(true,
						function(items) {
							group.properties = items;
					});
					return group;
				},
				resourceCreated : function(resource) {
				},
				deleted : function(resource) {
				},
				displayResource : function(resource, readOnly) {
					$('#groupId').val(resource.id);
					$('#groupName').val(resource.name);
					$('#groupName').attr('disabled', readOnly);
					getJSON(apiUrl + "/users/group/" + resource.id, null, function(data) {
						$('#tabGroupUsers').multipleSearchInput({
	 						selected : data.resources,
	 						disabled : readOnly
	 					});
					});
					getJSON(apiUrl + "/groups/group/" + resource.id, null, function(data) {
						$('#tabGroupGroups').multipleSearchInput({
	 						selected : data.resources,
	 						disabled : readOnly
	 					});
					});
					$('#groupProperties').parent().append($('#tabGroupUsers').detach());
					$('#groupProperties').parent().append($('#tabGroupGroups').detach());
					$('#groupProperties').empty();
					$('#groupProperties').propertyPage({
						url : apiUrl + '/group/properties/' + resource.id,
						showButtons : false,
						useTemplates : true,
						urlProcessor: function(url) {
							return url.replace('$' + '{realmApi}', apiUrl);
						},
						canUpdate : currentMenu.canUpdate,
						additionalTabs : [ {
							id : "tabGroupUsers",
							name : getResource("label.users")
						},
						{
							id : "tabGroupGroups",
							name : getResource("label.groups")
						}]
					});
 	 			  	
				},
				complete: function() {
					loadComplete();
				}
			});
	});
	

	
</script>