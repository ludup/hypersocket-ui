<div class="modal" id="pfxExport" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg"> 
		<div class="modal-content">
			<div class="modal-header lb-modal-header-text-reverse">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title" localize="pfxExport.title"></h4>
			</div>
			<div class="modal-body">
					<div class="propertyItem form-group lb-row">
						<label for="file" class="col-md-3 control-label"
							localize="pfxExport.passphrase.label"></label>
						<div class="propertyValue col-md-9">
							<input type="password" name="passphrase" autocomplete="off"
									id="pfx_passphrase" class="form-control" />
							<div>
								<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="pfxExport.passphrase.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group lb-row">
						<label for="file" class="col-md-3 control-label"
							localize="pfxExport.confirmPassphrase.label"></label>
						<div class="propertyValue col-md-9">
							<input type="password" name="confirmPassphrase" autocomplete="off"
									id="pfx_confirmPassphrase" class="form-control" />
							<div>
								<span class="lb-help-block form-text text-muted mt-2 mb-3 pl-1" localize="pfxExport.confirmPassphrase.info"></span>
							</div>
						</div>
					</div>
			</div>
			<div class="modal-footer">
				<button id="downloadPFXButton" type="button" class="btn btn-primary">
					<i id="downloadIcon" class="far fa-download"></i><span
						class="btn-text" localize="pfxExport.downloadButton.label"></span>
				</button>
			</div>
		</div>
	</div>

</div>
<script type="text/javascript">

	legacyjQueryReadyFix(function() {
		
		$('#pfxExport').localize();
		$('#pfxExport').data('action', function(resource) {
			$('#pfx_passphrase').val('');
			$('#pfx_confirmPassphrase').val('');
			$('#pfxExport').data('resource',resource.id);
			$('#pfxExport').modal('show');
		});
		
		$('#downloadPFXButton').click(function(e) {
			removeMessage();
			if($('#pfx_passphrase').val() != $('#pfx_confirmPassphrase').val()){
				showError(getResource("pfxExport.passphraseConfimation.error"));
				return;
			}
			$('#downloadIcon').removeClass('fa-download');
			$('#downloadIcon').addClass('fa-spinner fa-spin');
			var formData = new FormData();
			formData.append('passphrase', $('#pfx_passphrase').val());

			doAjax({
				type : 'POST',
				url : basePath + '/api/certificates/exportPfx/' + $('#pfxExport').data('resource'),  
				cache : false,
				contentType : false,
				processData : false,
				data : formData,
				success : function(data) {
					if(data.success) {
						$('#pfxExport').modal('hide');
						window.location = basePath + '/api/certificates/downloadPfx/' + $('#pfxExport').data('resource') + '?token=' + getCsrfToken();
					} else {
						showError(data.message);
					}
				},
				error : function(jqXHR,textStatus,errorThrown) {
					showError(errorThrown);
				},
				complete: function() {
					$('#downloadIcon').removeClass('fa-spinner fa-spin');
					$('#downloadIcon').addClass('fa-download');
				} 
			});
		});
		
	});
</script>