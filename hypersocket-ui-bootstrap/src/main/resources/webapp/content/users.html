<div id="contentUsers" class="col-md-12" style="padding-left: 0px">
	<div id="userDialog"></div>
	<div id="additionalActions"></div>
	<div id="realmsContent"></div>
</div>
<div id="linkDialog" class="modal" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 localize="linkAccount.label"></h4>
			</div>
			<div class="modal-body">
				<div class="propertyItem form-group">
					<label for="file" class="col-md-3 control-label"
						   localize="primaryAccount.label"></label>
					<div class="propertyValue col-md-9">
						<div id="primaryAccount"></div>
						<div>
							<span class="help-block" localize="primaryAccount.info"></span>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-ban"></i><span localize="text.cancel"></span></button>
				<button id="saveLinkedAccount" type="button" class="btn btn-primary"><i class="fa fa-save"></i><span localize="text.save"></span></button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	$(document).ready(
			function() {

				var apiUrl = 'currentRealm';
				var disableDecoration = false;
				var buttons = [];
				var userRealm = $(document).data('userRealm');
				var ownerRealm;
				if(userRealm) {
					ownerRealm = true;
				}
				var title = getResource('users.title');
				if(userRealm) {
					apiUrl = 'ownerRealm/' + userRealm.id;
					disableDecoration = true;
					buttons.push({
						resourceKey: 'backButton',
						buttonClass: 'btn-danger',
						icon: 'fa-step-backward',
						action: function(callback) {
							window.location = $(document).data('accounts.returnTo');
						}
					});
					title = getResource('ownerRealm.users.title').format(userRealm.name);
				} else {
					userRealm = currentRealm;
				}

				$(document).data('apiUrl', apiUrl);
				$(document).data('userRealm', null);
				$('#realmsContent').load(uiPath + '/content/realmsDialog.html', function() {
					
					$('#realmsContent').localize();
					
					$('div[dialog-for="realmsContent"]').resourceDialog(
						{ resourceUrl : "realms/realm", 
						  resourceKey : 'realm', 
						  validate : function() {
							  
							removeMessage();
							  
							if ($('#name').val() == '') {
								showError(getResource("text.nameRequired"));
								return false;
							}
							
							if(!$('#realmProperties').validateProperties()) {
								showError("error.correctValidationErrors");
								return false;
							}
							
							return true;
						}, clearDialog : function(create) {
							$('#name').val("");
							$('#name').attr('disabled', false);
							$('#id').val("");
							$('#realmProperties').clearProperties();
							removeMessage();
						}, createResource : function() {
							realm = new Object();
							realm.name = $('#name').val();
							realm.type = $('#typeButton').widget().getValue();
							realm.id = $('#id').val();

							$('#realmProperties').saveProperties(true,
								function(items) {
									realm.properties = items;
							});
							
							return realm;
						}, confirmed: function(resource, args) {
							if('realm.knownHosts' in resource.properties) {
								var pr = resource.properties['realm.knownHosts'] ;
								if(pr.value.length > 0)
									pr.value += ']|[';
								pr.value += args[3];
							}
							else {						
								resource.properties.push(new PropertyItem('realm.knownHosts', args[3]));
							}
						}, resourceUpdated : function(resource) {
							if(currentRealm.resourceCategory === 'local' && resource.type !== 'local') {
								window.location.hash = 'menu=users';
								window.location.reload();
							}
						}, displayResource : function(resource, readOnly) {

							$('#id').val(resource.id);
							$('#name').val(resource.name);
							
							if(resource.resourceCategory!=='local') {
								$('#typeButton').widget().disable();
							}
							
							$('#typeButton').widget().setValue(resource.resourceCategory);
							$('#realmProperties').propertyPage(
								{ url : 'realms/realm/properties/' + resource.id, 
									showButtons : false, 
									resource: resource,
									i18nNamespace: $('#typeButton').widget().getSelectedObject().module,
									displayMode: 'admin,update',
									canUpdate : currentMenu.canUpdate && !readOnly,
									
							});
						}
					});

				});
				
				$('#userDialog').load(uiPath + '/content/userDialog.html', function() {

				$('#contentUsers').localize();
				$('#linkDialog').localize();

				$('#primaryAccount').autoComplete({
					url:'currentRealm/users/table',
					remoteSearch: true,
					valueAttr: 'id'
				});

				$('#saveLinkedAccount').click(function(e) {
					e.preventDefault();
					removeMessage();
					var account = $('#linkDialog').data('account');
					var callback = $('#linkDialog').data('callback');

					if(!$('#primaryAccount').widget().getValue()) {
						showError(getResource("text.selectAccount"));
					} else {
						getJSON(apiUrl + '/linkAccount/' + account.id + '/' + $('#primaryAccount').widget().getValue(), null, function(data) {
							if(data.success) {
								showInformation(data.message);
								$('#contentUsers').resourcePage().refresh();
								$('#linkDialog').modal('hide');
							} else {
								showError(data.message);
							}
						});
					}
				});

				getJSON('menus/tableActions/userActions', null, function(data) {

					var actions = new Array();

					if(ownerRealm) {
						actions.push({
							resourceKey: 'linkAccount',
							iconClass: 'fa-link',
							action: function(resource, callback) {
								$('#linkDialog').data('account', resource);
								$('#linkDialog').data('callback', callback);
								$('#linkDialog').find('h4').text(getResource('linkedTo.text').format(resource.principalName));
								$('#linkDialog').modal('show');
							},
							enabled: true,
							isDisplayable: function(resource) {
								return !resource.linked;
							}
						});
						actions.push({
							resourceKey: 'unlinkAccount',
							iconClass: 'fa-chain-broken',
							action: function(resource, callback) {
								bootbox.confirm(getResource('unlinkTo.text').format(resource.principalName, resource.parentPrincipal.principalName), function(result) {
									if(result) {
										getJSON(apiUrl + '/unlinkAccount/' + resource.id, null, function(data) {
											if(data.success) {
												showInformation(data.message);
												$('#contentUsers').resourcePage().refresh();
											} else {
												showError(data.message);
											}
										});
									}
								});
							},
							enabled: true,
							isDisplayable: function(resource) {
								return resource.linked;
							}
						});
					}

					if(data.resources.length > 0) {
						$.each(data.resources, function(idx, action) {
							var div = action.resourceKey + 'Div';
							$('#additionalActions').append('<div id="' + div + '"></div>');
							$('#' + div).load(uiPath + '/content/' + action.url + '.html');
							actions.push({
								resourceKey : action.resourceKey,
								iconClass : action.iconClass,
								action : function(resource, callback) {
									if($('#' + action.resourceKey).data('action')) {
										$('#' + action.resourceKey).data('action')(resource, callback);
									}
								},
								enabled : true,
								enableFunction: action.enableFunction,
								displayFunction: action.displayFunction
							});
						});
					 }

					$('#userProperties').propertyPage({
						url : apiUrl + '/user/template/' + userRealm.resourceCategory,
						showButtons : false,
						displayMode: 'create,admin',
						useTemplates : true,
						propertyTabsLast: false,
						i18nNamespace: userRealm.resourceCategory,
						canUpdate : true,
						displayMode: 'admin,create',
						useFilters: true,
						additionalTabs : [ {
							id : "tabUserGroups",
							name : getResource("label.groups")
						},{
							id : "tabPassword",
							name : getResource("label.password")
						} ]
					});

					var fields = [ {
						name : "icon",
						width: 40,
						formatter: function(value, obj, index) {
							return '<div class="center"><i class="fa fa-2x ' 
							+ getResourceOrDefault(obj.realmModule + '.icon', 'fa-user') + '"></i></div>';
						}
					},{
						name : "name",
						formatter: function(value, obj, index) {
							return obj.principalName;
						}
					}, {
						name : "principalDesc",
						formatter: function(value, obj, index) {
							return obj.principalDescription;
						}
					}, {
						name : "email"
					},{
						name : "principalStatus",
						formatter: function(value, obj, index) {
							return getResource(value + '.label');
						}
					},{
						name : "expires",
						formatter: function(value, obj, index) {
							if(value) {
								return new Date(value).format();
							}
							return null;
						}
					}];

					if(ownerRealm) {
						fields.push({
							name: 'parentPrincipal',
							formatter: function(value, obj, index) {
								if(!obj.parentPrincipal) {
									return null;
								}
								if(obj.parentPrincipal.principalDesc) {
									return obj.parentPrincipal.principalDesc;
								}
								return obj.parentPrincipal.principalName;
							}
						});
					}

					var resourcePage = $('#contentUsers').ajaxResourcePage(

							{
								id: 'User',
								tableUrl : apiUrl + "/users/table",
								title : title,
								icon : 'fa-user',
								resourceUrl : apiUrl + "/user",
								deleteResourcesUrl : "currentRealm/bulk/users",
								disableDecoration: disableDecoration,
								fields : fields,
								resourceKey : 'user',
								canCreate : currentMenu.canCreate,
								canUpdate : true,
								checkReadOnly: false,
								additionalButtons: buttons,
								canDelete : true,
								checkDelete: function(row) {
									return !row.readOnly;
								},
								detailFormatter: ownerRealm ? undefined : function(index, resource, $element) {
									$element.extendedResourcePanel({resourceKey: "principalRoleMappingTab",
																	   resource: resource,
																	   data: {parentContainer : '#contentUsers'}
																	});
				    	    	},
								additionalActions : actions,
								checkbox : true,
								validate : function(create) {
									if ($('#userName').val().trim() == '') {
										showError("error.nameRequired");
										return false;
									}
									if(create) {
										if($('#userPassword').val().trim() == '') {
											showError("error.passwordEmpty");
											return false;
										}
										if($('#userPassword').val().trim() != $('#userConfirmPassword').val().trim()) {
											showError("error.passwordsNotMatched");
											return false;
										}
									}
									
									if(!$('#userProperties').validateProperties()) {
										showError("error.correctValidationErrors");
										return false;
									}
									
									return true;
								},
								clearDialog : function(create) {
									$('#userName').val('');
									$('#userName').attr('disabled', !create),
									$('#userId').val('');
									$('#userPassword').val('');
									$('#userConfirmPassword').val('');
									$('#userProperties').clearProperties();
									$('#tabUserGroups').remove();

									if(create) {
										$('.createOnly').show();
										$('#disableNotifications').prop('checked', true);
										var resourceCategory = currentRealm.resourceCategory;
										if($('#principalType').length > 0) {
											if($('#principalType').widget().getValue() !== '') {
												resourceCategory = $('#principalType').widget().getValue();
											}
										}
										
										
										$('#userProperties').parent().append($('#tabPassword').detach());
										$('#tabPassword').removeAttr("style");
										$('#userProperties').empty();
										
										var tabs = [];
										if(currentRealm.resourceCategory === resourceCategory) {
											
											$('#userProperties').parent().append('<div id="tabUserGroups"><div id="tabUserGroupsContent" class="col-xs-12"></div></div>');
											
											$('#tabUserGroupsContent').multipleSearchInput({
												nameAttr : 'principalName',
												disabled: !currentMenu.canUpdate,
												selectedIsObjectList: true,
												valueAttr: 'id',
												url: apiUrl + '/groups/table'
											});
											
											tabs.push({
														id : "tabUserGroups",
														name : getResource("label.groups")
											});
										}
								
										tabs.push({
												id : "tabPassword",
												name : getResource("label.password")
										});
										
										$('#userProperties').propertyPage({
											url : apiUrl + '/user/template/' + userRealm.resourceCategory,
											showButtons : false,
											displayMode: 'admin,create',
											useTemplates : true,
											propertyTabsLast: false,
											i18nNamespace: userRealm.resourceCategory,
											canUpdate : true,
											useFilters: true,
											additionalTabs : tabs
										});
									} else {
										$('.createOnly').hide();
									}
								},
								createResource : function() {

									user = new Object();
									user.id = $('#userId').val().trim();
									user.name = $('#userName').val().trim();
									user.password = $('#userPassword').val().trim();
									user.forceChange = $('#userForceChange').prop('checked') ? true : false;
									
									$('#userProperties').saveProperties(true,
											function(items) {
												user.properties = items;
											});
									user.groups = $('#tabUserGroupsContent').widget().getValue();
									
									if(!$('#disableNotifications').prop('checked')) {
										user.properties.push(new PropertyItem('disableNotifications', "true"));
									}
									return user;
								},
								resourceCreated : function(resource) {
									
								},
								deleted : function(resource) {

								},
								queryParams: function(params) {
									if($('#principalType').length > 0) {
										params.module = $('#principalType').widget().getValue();
									}
								},
								displayResource : function(resource, readOnly, copy) {

									var resourceCategory = currentRealm.resourceCategory;
									if($('#principalType').length > 0) {
										if($('#principalType').widget().getValue() !== '') {
											resourceCategory = $('#principalType').widget().getValue();
										}
									}
									
									$('#userName').val(resource.name);
									if(copy) {
										$('#userName').attr('disabled', false);
									} else {
										$('#userName').attr('disabled', readOnly || $('#userName').attr('disabled'));
									}
									$('#userId').val(resource.id);
									
									$('#tabPassword').hide();
									$('#tabUserGroups').remove();
																		
									getJSON(apiUrl + '/groups/user/' + resource.id, null, function(data) {
									
										var tabs = [];
										if(currentRealm.resourceCategory === resourceCategory) {
											$('#userProperties').parent().append('<div id="tabUserGroups"><div id="tabUserGroupsContent" class="col-xs-12"></div></div>');
											$('#tabUserGroupsContent').multipleSearchInput({
												nameAttr : 'principalName',
												disabled: !currentMenu.canUpdate,
												selectedIsObjectList: true,
												selected : data.resources,
												valueAttr: 'id',
												url: "currentRealm/groups/table"
											});
						
											tabs.push({
														id : "tabUserGroups",
														name : getResource("label.groups")
											});
										} 

										if(copy) {
											tabs.push({
													id : "tabPassword",
													name : getResource("label.password")
												});
										}
										
										$('#userProperties').parent().append($('#tabPassword').detach());
										
										$('#userProperties').empty();
										$('#userProperties').propertyPage({
											url : apiUrl + '/user/properties/' + resource.id,
											showButtons : false,
											displayMode: 'admin,update',
											canUpdate : true,
											propertyTabsLast: false,
											i18nNamespace: userRealm.resourceCategory,
											useFilters: true,
											additionalTabs : tabs,
											complete: function() {
												if(tabs.length > 1) {
													$('#tabPassword').removeAttr("style");
												}
											}
										});

										$('#addUserModal').modal('show');

									});
									
								},
								complete : function() {
									
									if(currentRealm.resourceCategory !== 'local') {
										$('#contentUsers').find('.fixed-table-toolbar').last().append('<div class="tableToolbar pull-right search"><div class="principalType" id="principalType"></div></div>');
											$('#principalType').textDropdown({
											values: [{
												value: '',
												name: getResource('all.accounts')
											},{
												value: 'local',
												name: getResource('local.accounts')
											}, {
												value: currentRealm.resourceCategory,
												name: getResource(currentRealm.resourceCategory + '.accounts')
											}],
											value: '',
											changed: function(widget) {
												$('.search input[placeholder="Search"]').val('');
												resourcePage.refresh();
											},
											sortOptions: false
										});
									} 

									if(!ownerRealm) {
										$('#contentUsers').find('.fixed-table-toolbar').last().append(
												'<div class="tableToolbar pull-right search"><div><a id="configureUsers" href="#">' 
												+ getResource('configure.remote.text') + '</a></div></div>');
										$('#configureUsers').click(function(e) {
											e.preventDefault();
											$('div[dialog-for="realmsContent"]').resourceDialog('edit', currentRealm);
										});
									}
									
									loadComplete();
								}
							});
					
				});
				
				});

			});
</script>