<div id="contentUsers" class="col-md-12" style="padding-left: 0px">
	<!-- Modal -->
	<div class="modal" id="addUserModal" tabindex="-1" role="dialog"
		aria-labelledby="addUserModalLabel" aria-hidden="true"
		dialog-for="contentUsers">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="myModalLabel"></h4>
				</div>
				<div class="modal-body">
					<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="user.name"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control"
								placeholder="" id="userName" maxlength="" name="name" value="">
							<div>
								<span class="help-block" localize="user.name.info"></span>
							</div>
						</div>
					</div>
					<div id="userProperties" class="tabContent"></div>
					<div id="tabUserGroups" class="tabContent"></div>
					<div id="tabPassword" class="tabContent">
						<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="label.password"></label>
						<div class="propertyValue col-md-9">
							<input type="password" name="password" id="userPassword"
								class="form-control" />
							<div>
								<span class="help-block" localize="password.info"></span>
							</div>
						</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="label.confirmPassword"></label>
							<div class="propertyValue col-md-9">
								<input type="password" name="confirmPassword" id="userConfirmPassword"
									class="form-control" />
								<div>
									<span class="help-block" localize="confirmPassword.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="label.forceChange"></label>
							<div class="propertyValue col-md-9">
								<input type="checkbox" name="forceChange" id="userForceChange">
								<div>
									<span class="help-block" localize="forceChange.info"></span>
								</div>
							</div>
						</div>
					</div>
					<input type="hidden" name="userId" id="userId">

				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
	<div id="additionalActions"></div>
</div>
<script type="text/javascript">
	$(document).ready(
			function() {
				$('#contentUsers').localize();

				$('#tabUserGroups').multipleSelect({
					nameAttr : 'principalName',
					disabled: !currentMenu.canUpdate,
					selectedIsObjectList : true,
					url: "currentRealm/groups/list",
					getUrlData: function(data) {
						return data.resources;
					}
				});
		

				getJSON('menus/tableActions/userActions', null, function(data) {
					
					var actions = new Array();
					
					if(data.resources.length > 0) {
						$.each(data.resources, function(idx, action) {
							var div = action.resourceKey + 'Div';
							$('#additionalActions').append('<div id="' + div + '"></div>');
							$('#' + div).load('content/' + action.url + '.html');
							actions.push({
								resourceKey : action.resourceKey,
								iconClass : action.iconClass,
								action : function(resource, callback) {
									if($('#' + action.resourceKey).data('action')) {
										$('#' + action.resourceKey).data('action')(resource, callback);
									}
								},
								enabled : true,
								enableFunction: action.enableFunction,
								displayFunction: action.displayFunction
							});
						});
					 }
					
					$('#userProperties').propertyPage({
						url : 'currentRealm/user/template/' + currentRealm.resourceCategory,
						showButtons : false,
						displayMode: 'create',
						useTemplates : true,
						propertyTabsLast: false,
						canUpdate : currentMenu.canUpdate,
						displayMode: 'admin',
						additionalTabs : [ {
							id : "tabUserGroups",
							name : getResource("label.groups")
						},{
							id : "tabPassword",
							name : getResource("label.password")
						} ]
					});
					
					$('#contentUsers').ajaxResourcePage(
							{
								tableUrl : "currentRealm/users/table",
								title : getResource('users.title'),
								icon : 'fa-user',
								resourceUrl : "currentRealm/user",
								fields : [ {
									name : "principalName"
								}],
								resourceKey : 'user',
								canCreate : currentMenu.canCreate,
								canUpdate : currentMenu.canUpdate,
								canDelete : currentMenu.canDelete,
								additionalActionsDropdown: true,
								additionalActions : actions,
								validate : function(create) {
									if ($('#userName').val() == '') {
										showError("error.nameRequired");
										return false;
									}
									if(create) {
										if($('#userPassword').val() == '') {
											showError("error.passwordEmpty");
											return false;
										}
										if($('#userPassword').val() != $('#userConfirmPassword').val()) {
											showError("error.passwordsNotMatched");
											return false;
										}
									}
									
									if(!$('#userProperties').validateProperties()) {
										showError("error.correctValidationErrors");
										return false;
									}
									
									return true;
								},
								clearDialog : function(create) {
									$('#userName').val('');
									$('#userName').attr('disabled', !create),
									$('#userId').val('');
									$('#userPassword').val('');
									$('#userConfirmPassword').val('');
									$('#userProperties').clearProperties();
									$('#tabUserGroups').multipleSelect();
									
									if(create) {
										
										$('#userProperties').parent().append($('#tabUserGroups').detach());
										$('#userProperties').parent().append($('#tabPassword').detach());
										$('#tabPassword').removeAttr("style");
										$('#userProperties').empty();
										
										$('#userProperties').propertyPage({
											url : 'currentRealm/user/template/' + currentRealm.resourceCategory,
											showButtons : false,
											displayMode: 'create',
											useTemplates : true,
											propertyTabsLast: false,
											canUpdate : currentMenu.canUpdate,
											displayMode: 'admin',
											additionalTabs : [ {
												id : "tabUserGroups",
												name : getResource("label.groups")
											},{
												id : "tabPassword",
												name : getResource("label.password")
											} ]
										});
									} 
								},
								createResource : function() {

									user = new Object();
									user.id = $('#userId').val();
									user.name = $('#userName').val();
									user.password = $('#userPassword').val();
									user.forceChange = $('#userForceChange').attr('checked') ? true : false;
									
									$('#userProperties').saveProperties(true,
											function(items) {
												user.properties = items;
											});
									user.groups = $('#tabUserGroups').widget().getValue();
									return user;
								},
								resourceCreated : function(resource) {
									
								},
								deleted : function(resource) {

								},
								displayResource : function(resource, readOnly) {

									$('#userName').val(resource.name);
									$('#userName').attr('disabled', readOnly || $('#userName').attr('disabled'));
									$('#userId').val(resource.id);
									
									getJSON('currentRealm/groups/user/' + resource.id, null, function(data) {
										
										$('#userProperties').parent().append($('#tabUserGroups').detach());
										$('#userProperties').parent().append($('#tabPassword').detach());
										$('#tabPassword').hide();
										$('#userProperties').empty();
										$('#userProperties').propertyPage({
											url : 'currentRealm/user/properties/' + resource.id,
											showButtons : false,
											displayMode: 'update',
											canUpdate : !readOnly,
											displayMode: 'admin',
											propertyTabsLast: false,
											additionalTabs : [ {
												id : "tabUserGroups",
												name : getResource("label.groups")
											} ]
										});

										$('#tabUserGroups').multipleSelect({
											selected : data.resources,
											disabled: !currentMenu.canUpdate || readOnly,
										});

										$('#addUserModal').modal('show');

									});
									
								},
								complete : function() {
									loadComplete();
								}
							});
					
				});

			});
</script>