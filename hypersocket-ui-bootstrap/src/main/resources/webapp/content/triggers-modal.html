<div id="triggerModal">
	<div class="modal" id="addTriggerForm" tabindex="-1" role="dialog" dialog-for="contentTriggers">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="name.label"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control"
								placeholder="" id="resourceName" maxlength="" name="resourceName" value="">
							<div>
								<span class="help-block" localize="name.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="event.label"></label>
						<div class="propertyValue col-xs-9">
							<div id="eventAuto"></div>
							<div>
								<span class="help-block" localize="event.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group requiresEvent">
						<label class="col-xs-3 control-label" localize="event.result.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="eventResult"></div>
								<div>
								<span class="help-block" localize="event.result.info"></span>
							</div>
						</div>	
					</div>
					<div class="propertyItem form-group requiresEvent">
						<label class="col-xs-3 control-label" localize="event.task.label"></label>
						<div class="propertyValue col-xs-9">
							<div id="taskAuto"></div>
							<div>
								<span class="help-block" localize="event.task.info"></span>
							</div>
						</div>
					</div>
					<div id="allTabs">
						<div id="tabProperties"></div>
						<div id="tabConditions">
							<div class="row">
								<div class="col-xs-12">
									<p localize="allConditions.text"></p>
								</div>
							</div>
							<div id="rowAll" class="row"></div>
							<div class="row">
								<div class="propertyItem form-group">
									<div class="propertyValue col-xs-11">
										<span class="help-block" localize="addCondition.text"></span>
									</div>
									<div class="propertyValue col-xs-1 dialogActions">
										<a id="addAll" href="#" class="btn btn-info addButton"><i class="fa fa-plus"></i></a>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-xs-12">
									<p localize="anyConditions.text"></p>
								</div>
							</div>
							<div id="rowAny" class="row"></div>
							<div class="row">
								<div class="propertyItem form-group">
									<div class="propertyValue col-xs-11">
										<span class="help-block" localize="addCondition.text"></span>
									</div>
									<div class="propertyValue col-xs-1 dialogActions">
										<a id="addAny" href="#" class="btn btn-info addButton"><i class="fa fa-plus"></i></a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<input type="hidden" id="resourceId" name="resourceId" value="" />
				<input type="hidden" id="parentId" name="parentId" value="" />
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
</div>

<script type="text/javascript">

	
    function addConditionRow(divId, condition) {
    	
    	var event = $('#triggerModal').data('selectedEvent');
    	var parentEvents = $('#triggerModal').data('parentEvents');
    	
    	var conditions = $('#triggerModal').data('conditions');
    	
    	var conditionId;
    	var conditionClass;
    	if(condition) {
    		conditionId = 'id="{0}' + condition.id + '"';
    		conditionClass = "existingCondition";
    	} else {
    		conditionId = "";
    		conditionClass = "newCondition";
    	}
    	var html = '<div class="propertyItem form-group ' + conditionClass + ' ' + divId + ' condition">'
    			 + '    <div class="propertyValue col-xs-4">'
    			 + '        <input type="hidden" class="conditionId" name="conditionId" value="' + (condition ? condition.id : '') + '">'
    			 + '        <select ' + conditionId.format('attribute') + ' class="form-control attributeKey">';
    	
    	var tmp = new Array();
    	var tmp2 = new Array();
    	$.each(event.attributeNames, function(idx, obj) {
    		var resource = event.i18nNamespace != '' && !obj.startsWith('attr.') && !obj.startsWith('currentUser.') ? getResource(event.i18nNamespace + '.' + obj) : getResource(obj);
    		tmp[resource] = obj;
    		tmp2.push(resource);
    	});

    	if(parentEvents) {
    		$.each(parentEvents, function(i, parentEvent) {
		    	$.each(parentEvent.attributeNames, function(idx, obj) {
		    		var resource = parentEvent.i18nNamespace != '' && !obj.startsWith('attr.') && !obj.startsWith('currentUser.') ? getResource(parentEvent.i18nNamespace + '.' + obj) : getResource(obj);
		    		tmp[resource] = obj;
		    		tmp2.push(resource);
		    	});
    		});
    	}
    	
    	$.each(tmp2.sort(), function(idx, obj) {
    		html += '<option value="' + tmp[obj] + '">' + obj + '</option>';
    	});
    	
   		html += '        </select>'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-3">'
   			 + '        <select ' + conditionId.format('condition') + ' class="form-control conditionKey">';
   		
		$.each(conditions, function(idx, obj) {
    		html += '<option value="' + obj + '">' + getResource(obj) + '</option>';
    	});
 			
   		html += '</select>'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-4" style="display: inline-block">'
   			 + '        <input type="text" class="form-control conditionValue" size="30"'
   			 + '            ' + conditionId.format('conditionValue') + ' name="conditionValue" value="">'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-1 dialogActions">'
   			 + '         <a href="#" class="removeCondition btn btn-danger"><i class="fa fa-trash-o"></i></a>'
   			 + '    </div>'
   			 + '</div>';
    	$('#'+divId).append(html);
    	
    	if(condition) {
	    	$('#attribute' + condition.id).data('condition', condition);
	    	$('#attribute' + condition.id).val(condition.attributeKey);
	    	$('#condition' + condition.id).val(condition.conditionKey);
	    	$('#conditionValue' + condition.id).val(condition.conditionValue);
    	}
    	
    	$('.removeCondition').off('click');
    	$('.removeCondition').on('click', function(e) {
    		e.preventDefault();
    		$(this).closest('.condition').remove();
    	});
    }
    
    function getAttributeNames() {
    	
    	var variables = $('#triggerModal').data('selectedEvent').attributeNames;
    	
    	if($('#triggerModal').data('parentEvents')) {
    		$.each($('#triggerModal').data('parentEvents'), function(idx, obj) {
    			variables = variables.concat(obj.attributeNames);
    		});
    	}
    	
    	return variables;
    }
    
	$(document).ready(function() {
		
		$('#triggerModal').localize();
		$('#allTabs').hide();
		
		$('.requiresEvent').hide();
		
		$('.addButton').attr('disabled', true);
		
		var eventResult = $('#eventResult').selectButton({
			id: 'result',
			url: 'triggers/eventResults',
			nameIsResourceKey: true,
			resourceKeyTemplate: '{0}.label',
			getUrlData: function(data) {
				return data.resources;
			},
			changed: function(result) {
				
			}
		});
		
		eventResult.selectFirst();
		
		var eventAuto = $('#eventAuto').autoComplete({
			id: 'eventA',
			url: 'triggers/events',
			nameAttr: 'resourceKey',
			valueAttr: 'resourceKey',
			nameIsResourceKey: true,
			changed: function(event) {
				
				if(event) {
					$('.requiresEvent').show();
					$('.addButton').attr('disabled', false);
					if(!displaying) {
						if(!$('#rowAll').is(':empty') || !$('#rowAny').is(':empty')) {
							bootbox.confirm(getResource("confirmConditionsDeletion.text"),
									function(confirmed) {
										if (confirmed) {
											$('#rowAll').empty();
											$('#rowAny').empty();
										} 
									});
						}
					}
					$('#triggerModal').data('selectedEvent', event);
				} else {
					$('.requiresEvent').hide();
				}
			}
		});
		
		
		
		var displaying = false;
		var taskAuto = $('#taskAuto').autoComplete({
			url: 'triggers/tasks',
			nameIsResourceKey: true,
			resourceKeyTemplate: '{0}.label',
			getUrlData: function(data) {
				return data.resources;
			},
			changed: function(widget) {
				$('#tabProperties').parent().append($('#tabConditions').detach());
				$('#tabProperties').empty();
				if(widget.value != '') {
					if(taskAuto.isEnabled()) {
						$('#tabProperties').propertyPage({ 
							url : 'triggers/task/' + widget.name, 
							showButtons : false, 
							i18nNamespace: 'triggers',
							canUpdate : currentMenu.canUpdate, 
							useTemplates : true,
							variables: getAttributeNames(),
							propertyTabsLast: true,
							additionalTabs : [ {
								id : "tabConditions",
								name : getResource("tabConditions.label")
							}],
							complete: function() {
								$('#allTabs').show();
							}
						});
					}
				} else {
					$('.requiresEvent').hide();
				}
			}
		});
		
		$(document).data('triggerModalCallback', {
			clearDialog: function(create) {
				$('.requiresEvent').hide();
				$('#rowAll').empty();
				$('#rowAny').empty();
				$('#resourceName').val('');
				$('#resourceId').val('');
				$('#allTabs').hide();
				eventAuto.clear();
				eventAuto.reset();
				eventAuto.enable();
				taskAuto.clear();
				taskAuto.enable();
				
				var parentResource = $('#triggerModal').data('parentResource');
				if(parentResource) {
					getJSON('triggers/actionResults/' + parentResource.id, null, function(data) {
						eventAuto.setValue(data.resources[0].resourceKey);
						eventAuto.disable();	
					});
				} 
				
				eventResult.selectFirst();
				$('.tabPropertiesTab').first().trigger('click');
				$('.addButton').attr('disabled', true);
				
				$('#tabProperties').parent().append($('#tabConditions').detach());
				$('#tabProperties').empty();
			},
			loadParent: function(parentResource, parentEvents) {
				$('#triggerModal').data('parentEvents', parentEvents);
				$('#triggerModal').data('parentResource', parentResource);
			},
			displayResource: function(resource) {
				
				debugger;
				$('#resourceId').val(resource.id);
				$('#parentId').val(resource.parentId);
				$('#resourceName').val(resource.name);
				eventAuto.setValue(resource.event);
				eventAuto.disable();

				eventResult.setValue(resource.result);

				$.each(resource.allConditions, function(idx, obj) {
					addConditionRow('rowAll', obj);
				});
				
				$.each(resource.anyConditions, function(idx, obj) {
					addConditionRow('rowAny', obj);
				});
				
				taskAuto.disable();
				taskAuto.setValue(resource.resourceKey);

				$('#tabProperties').propertyPage({ 
					url : 'triggers/properties/' + resource.id, 
					showButtons : false, 
					i18nNamespace: 'triggers',
					canUpdate : currentMenu.canUpdate, 
					useTemplates : true,
					variables: getAttributeNames(),
					propertyTabsLast: true,
					additionalTabs : [ {
						id : "tabConditions",
						name : getResource("tabConditions.label")
					}],
					complete: function() {
						$('#allTabs').show();
					}
				});
				
			},
			validate: function() {
				if ($('#resourceName').val().trim() == '') {
					showError("error.nameRequired");
					return false;
				}
				if (!eventAuto.getValue()) {
					showError("error.eventRequired");
					return false;
				}
				
				if (!taskAuto.getValue()) {
					showError("error.eventRequired");
					return false;
				}
				
				if(!$('#automationProperties').validateProperties()) {
					showError("error.correctValidationErrors");
					return false;
				}
				return true;
			},
			createResource: function() {
				resource = new Object();
				resource.id = $('#resourceId').val();
				resource.parentId = $('#parentId').val();
				resource.name = $('#resourceName').val();
				resource.event = eventAuto.getValue();
				resource.task = taskAuto.getValue();
				resource.result = eventResult.getValue();
				if($('#triggerModal').data('parentResource')) {
					resource.parentId = $('#triggerModal').data('parentResource').id;
				}
				
				$('#tabProperties').saveProperties(true, function(items) {
					resource.properties = items;	
				});
				
				resource.allConditions = new Array();
				
				$('.rowAll').each(function() {
					
					var condition = new Object();
					condition.id = $(this).find('.conditionId').first().val();
					condition.attributeKey = $(this).find('.attributeKey').first().val();
					condition.conditionKey = $(this).find('.conditionKey').first().val();
					condition.conditionValue = $(this).find('.conditionValue').first().val();
					
					log("Adding all condition " + condition.attributeKey + "/" + condition.conditionKey + "=" + condition.conditionValue);
					resource.allConditions.push(condition);
				});
				
				resource.anyConditions = new Array();
				
				$('.rowAny').each(function() {
					var condition = new Object();
					condition.id = $(this).find('.conditionId').first().val();
					condition.attributeKey = $(this).find('.attributeKey').first().val();
					condition.conditionKey = $(this).find('.conditionKey').first().val();
					condition.conditionValue = $(this).find('.conditionValue').first().val();
					
					log("Adding any condition " + condition.attributeKey + "/" + condition.conditionKey + "=" + condition.conditionValue);
					resource.anyConditions.push(condition);
				});
				return resource;
			}
		});
		
		getJSON('triggers/conditions', null, function(data) {
			$('#triggerModal').data('conditions', data.resources);
		});
		
// 		getJSON('triggers/actions', null, function(data) {
// 			$('#triggerModal').data('actions', data.resources);
// 			$('#addActionDropdown').empty();
// 			$.each(data.resources, function(idx, obj) {
// 				$('#addActionDropdown').append('<li><a tabindex="-1" href="#" class="editAction" data-value="' + obj + '">' + getResource(obj) + '</a></li>');
// 			});
// 			$(".dropdown-toggle").dropdown();
			
// 			bindActions();
// 		});
		
		$('#addAll').click(function(e) {
			e.preventDefault();
			addConditionRow('rowAll');
			
			
		});
		
		$('#addAny').click(function(e) {
			e.preventDefault();
			addConditionRow('rowAny');
		});
		
		/**
		 * Fix for stackable modals in Bootstrap 3
		 * http://miles-by-motorcycle.com/static/bootstrap-modal/index.html
		 */
		$('.modal').on('hidden.bs.modal', function(event) {
		    $(this).removeClass( 'fv-modal-stack' );
		    $('body').data( 'fv_open_modals', $('body').data( 'fv_open_modals' ) - 1 );
		});

		$('.modal').on('shown.bs.modal', function (event) {
		       
		   // keep track of the number of open modals
		   if ( typeof( $('body').data('fv_open_modals')) == 'undefined') {
		     $('body').data('fv_open_modals', 0);
		   }
		   
		   // if the z-index of this modal has been set, ignore.         
		    if ($(this).hasClass('fv-modal-stack')) {
		    	return;
		    }
		   
		    $(this).addClass('fv-modal-stack');

		    $('body').data('fv_open_modals', $('body').data('fv_open_modals') + 1);

		    $(this).css('z-index', 1040 + (10 * $('body').data('fv_open_modals')));

		    $('.modal-backdrop').not('.fv-modal-stack' )
		            .css( 'z-index', 1039 + (10 * $('body').data('fv_open_modals')));

		    $('.modal-backdrop').not('fv-modal-stack')
		            .addClass('fv-modal-stack');

		});
	});
</script>