<div id="triggerModal">
	<div class="modal" id="addTriggerForm" tabindex="-1" role="dialog" dialog-for="contentTriggers">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="propertyItem form-group">
						<label class="col-md-3 control-label" localize="name.label"></label>
						<div class="propertyValue col-md-9">
							<input type="text" class="form-control propertyInput"
								placeholder="" id="resourceName" maxlength="" name="resourceName" value="">
							<div>
								<span class="help-block" localize="name.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="event.label"></label>
						<div class="propertyValue col-xs-9">
							<div id="eventAuto"></div>
							<div>
								<span class="help-block" localize="event.info"></span>
							</div>
						</div>
					</div>
					<div class="propertyItem form-group">
						<label class="col-xs-3 control-label" localize="event.result.label"></label>
							<div class="propertyValue col-xs-9">
								<div id="eventResult"></div>
								<div>
								<span class="help-block" localize="event.result.info"></span>
							</div>
						</div>	
					</div>
					<div id="tabProperties"></div>
					<div id="tabActions">
						<div class="row">
							<div class="col-xs-12">
								<p localize="performActions.text"></p>
							</div>
						</div>
						<div id="rowActions" class="row">
						</div>
						<div class="row">
							<div class="propertyItem form-group">
								<div class="propertyValue col-xs-10">
									<span class="help-block" localize="addAction.text"></span>
								</div>
								<div class="propertyValue col-xs-2 dialogActions">
									<div class="btn-group">
										<a id="addAction" href="#" class="dropdown dropdown-toggle btn btn-info addButton" data-toggle="dropdown"><i class="fa fa-plus"></i>
										  <ul id="addActionDropdown" class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="addAction">
										  	<li><a tabindex="-1" href="#"></a></li>
										  </ul>
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="tabConditions">
						<div class="row">
							<div class="col-xs-12">
								<p localize="allConditions.text"></p>
							</div>
						</div>
						<div id="rowAll" class="row"></div>
						<div class="row">
							<div class="propertyItem form-group">
								<div class="propertyValue col-xs-11">
									<span class="help-block" localize="addCondition.text"></span>
								</div>
								<div class="propertyValue col-xs-1 dialogActions">
									<a id="addAll" href="#" class="btn btn-info addButton"><i class="fa fa-plus"></i></a>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12">
								<p localize="anyConditions.text"></p>
							</div>
						</div>
						<div id="rowAny" class="row"></div>
						<div class="row">
							<div class="propertyItem form-group">
								<div class="propertyValue col-xs-11">
									<span class="help-block" localize="addCondition.text"></span>
								</div>
								<div class="propertyValue col-xs-1 dialogActions">
									<a id="addAny" href="#" class="btn btn-info addButton"><i class="fa fa-plus"></i></a>
								</div>
							</div>
						</div>
					</div>
				</div>
				<input type="hidden" id="resourceId" name="resourceId" value="" />
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
</div>
<div class="modal" id="actionForm" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button id="closeAction" type="button" class="close" >&times;</button>
				<h4 class="modal-title" id="addActionTitle"></h4>
			</div>
			<div class="modal-body">
				<div class="propertyItem form-group">
					<label class="col-md-3 control-label" localize="action.name.label"></label>
					<div class="propertyValue col-md-9">
						<input type="text" class="form-control propertyInput"
							placeholder="" id="actionName" maxlength="" name="actionName" value="">
						<div>
							<span class="help-block" localize="action.name.info"></span>
						</div>
					</div>
				</div>
				<div id="actionProperties"></div>
				<input name="id" id="id" type="hidden" class="formInput" />
			</div>
			<div class="modal-footer">
				<button type="button" id="createAction" class="btn btn-primary">Create</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

	function updateActionRow(action) {
		$('#action' + action.id).data('action', action);
		$('#actionName' + action.id).val(action.name);
	}
	
	function addActionRow(action) {
		$('#rowActions').append('<div class="propertyItem form-group">' +
		                              '<div class="propertyValue col-xs-10">' + 
		                              '<input type="text" disabled="disabled" class="form-control propertyInput conditionValue ' 
		                              		+ '" size="30"' +  'id="actionName' + action.id
		                              			+ '" name="actionName" value="' + action.name + '">' + 
	   			 				 	  '</div>' +
									  '<div class="propertyValue col-xs-2 dialogActions">' +
									  		'<a href="#" id="action' + action.id + '" class="btn btn-info editAction" data-value="' 
									  				+ action.resourceKey + '"><i class="fa fa-edit"></i></a>' 
									  					+ '<a href="#" class="removeAction btn btn-danger"><i class="fa fa-trash-o"></i></a>' +
								  '</div>' +
								'</div>');
		
		$('#action' + action.id).data('action', action);
		
		bindActions();
	}
	
    function addConditionRow(divId, condition) {
    	
    	var event = $('#triggerModal').data('selectedEvent');
    	var conditions = $('#triggerModal').data('conditions');
    	
    	var conditionId;
    	var conditionClass;
    	if(condition) {
    		conditionId = 'id="{0}' + condition.id + '"';
    		conditionClass = "existingCondition";
    	} else {
    		conditionId = "";
    		conditionClass = "newCondition";
    	}
    	var html = '<div class="propertyItem form-group ' + conditionClass + ' ' + divId + ' condition">'
    			 + '    <div class="propertyValue col-xs-4">'
    			 + '        <input type="hidden" class="conditionId" name="conditionId" value="' + (condition ? condition.id : '') + '">'
    			 + '        <select ' + conditionId.format('attribute') + ' class="form-control propertyInput attributeKey">';
    	$.each(event.attributeNames, function(idx, obj) {
    		html += '<option value="' + obj + '">' + getResource(obj) + '</option>';
    	});
    	
   		html += '        </select>'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-3">'
   			 + '        <select ' + conditionId.format('condition') + ' class="form-control propertyInput conditionKey">';
   		
		$.each(conditions, function(idx, obj) {
    		html += '<option value="' + obj + '">' + getResource(obj) + '</option>';
    	});
 			
   		html += '</select>'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-4" style="display: inline-block">'
   			 + '        <input type="text" class="form-control propertyInput conditionValue" size="30"'
   			 + '            ' + conditionId.format('conditionValue') + ' name="conditionValue" value="">'
   			 + '    </div>'
   			 + '    <div class="propertyValue col-xs-1 dialogActions">'
   			 + '         <a href="#" class="removeCondition btn btn-danger"><i class="fa fa-trash-o"></i></a>'
   			 + '    </div>'
   			 + '</div>';
    	$('#'+divId).append(html);
    	
    	if(condition) {
	    	$('#attribute' + condition.id).data('condition', condition);
	    	$('#attribute' + condition.id).val(condition.attributeKey);
	    	$('#condition' + condition.id).val(condition.conditionKey);
	    	$('#conditionValue' + condition.id).val(condition.conditionValue);
    	}
    	
    	$('.removeCondition').off('click');
    	$('.removeCondition').on('click', function(e) {
    		e.preventDefault();
    		$(this).closest('.condition').remove();
    	});
    }
    
    function bindActions() {
    	
    	$('.removeAction').off('click');
		$('.removeAction').on('click', function(e) {
			e.preventDefault();
			var row = $(this).closest('.propertyItem');
			bootbox.confirm(getResource("deleteAction.text"),
					function(confirmed) {
						if (confirmed) {
							row.remove();
						} 
					});
		});
		
    	$('.editAction').off('click');
		$('.editAction').on('click', function(e) {
			e.preventDefault();
			var currentRow = $(this);
			var action = $(this).data('action');
			var resourceKey = $(this).data('value');
			var url = 'triggers/action/template/' + resourceKey;

			if(action) {
				$('#createAction').empty();
				$('#createAction').append('<i class="fa fa-save"></i><span>' + getResource("text.update") + '</span>');	
				$('#addActionTitle').text(getResource("update.action.title"));
				$('#actionName').val(action.name);
				if(!action.newAction) {
					url = 'triggers/action/properties/' + action.id;
				}
			} else {
				$('#createAction').empty();
				$('#createAction').append('<i class="fa fa-save"></i><span>' + getResource("text.create") + '</span>');	
				$('#addActionTitle').text(getResource("create.action.title"));
				$('#actionName').val('');
			}
			
			$('#closeAction').on('click', function(e) {
				$('#createAction').off('click');
				$('#closeAction').off('click');
				$('#actionForm').modal('hide');
			});
			
			$('#createAction').on('click', function(e) {
				if(!action) {
					action = new Object();
					action.id = new Date().getTime();
					action.newAction = true;
					action.resourceKey = resourceKey;
				} else {
					action.newAction = false;
				}
				
				if($('#actionName').val()=='') {
					alert(getResource("error.nameRequired"));
					return;
				}
				action.name = $('#actionName').val();
				
				$('#actionProperties').saveProperties(true, function(items) {
						action.properties = items;
				});
				
				$('#createAction').off('click');
				if(action.newAction) {
					addActionRow(action);
				} else {
					updateActionRow(action);
				}
				$('#actionForm').modal('hide');
			});
			
			$('#actionProperties').empty();
			$('#actionProperties').propertyPage({
				url : url,
				showButtons : false,
				useTemplates : true,
				canUpdate : currentMenu.canUpdate,
				variables: $('#triggerModal').data('selectedEvent').attributeNames,
				items: (action ? action.properties : null),
				complete : function() {
					$('#actionForm').modal('show');
				}
			});
		});
    }
    
	$(document).ready(function() {
		
		$('#triggerModal').localize();
		$('.addButton').attr('disabled', true);
		
		var eventResult = $('#eventResult').selectButton({
			id: 'result',
			url: 'triggers/eventResults',
			nameIsResourceKey: true,
			resourceKeyTemplate: '{0}.label',
			name: 'result',
			value: 'event_success',
			changed: function(result) {
				
			}
		});
		var eventAuto = $('#eventAuto').autoComplete({
			id: 'eventA',
			url: 'triggers/events',
			nameAttr: 'resourceKey',
			valueAttr: 'resourceKey',
			nameIsResourceKey: true,
			changed: function(event) {
				
				if(event) {
					$('.addButton').attr('disabled', false);
					if(!$('#rowAll').is(':empty') || !$('#rowAny').is(':empty')) {
						bootbox.confirm(getResource("confirmConditionsDeletion.text"),
								function(confirmed) {
									if (confirmed) {
										$('#rowAll').empty();
										$('#rowAny').empty();
									} 
								});
					}
					
					$('#triggerModal').data('selectedEvent', event);
				}
			}
		});
		
		$('#tabProperties').propertyPage({
			url : 'triggers/template',
			showButtons : false,
			useTemplates : true,
			canUpdate : currentMenu.canUpdate,
			additionalTabs : [ {
				id : "tabConditions",
				name : getResource("tabConditions.label")
			},{
				id : "tabActions",
				name : getResource("tabActions.label")
			}]
		});
		
		$(document).data('triggerModalCallback', {
			clearDialog: function(create) {
				$('#rowAll').empty();
				$('#rowAny').empty();
				$('#rowActions').empty();
				$('#resourceName').val('');
				$('#resourceId').val('');
				eventAuto.reset();
				eventAuto.enable();
				eventResult.reset();
				$('.tabPropertiesTab').first().trigger('click');
				$('#tabProperties').clearProperties();
				$('.addButton').attr('disabled', true);
				
				if(create) {
					
					$('#tabProperties').parent().append($('#tabConditions').detach());
					$('#tabProperties').parent().append($('#tabActions').detach());
					$('#tabProperties').empty();
					
					$('#tabProperties').propertyPage({
						url : 'triggers/template',
						showButtons : false,
						useTemplates : true,
						canUpdate : currentMenu.canUpdate,
						additionalTabs : [ {
							id : "tabConditions",
							name : getResource("tabConditions.label")
						},{
							id : "tabActions",
							name : getResource("tabActions.label")
						}]
					});
				}
			},
			displayResource: function(resource) {
				
				
				$('#resourceId').val(resource.id);
				$('#resourceName').val(resource.name);
				eventAuto.setValue(resource.event);
				eventAuto.disable();
				eventResult.setValue(resource.result);

				$.each(resource.allConditions, function(idx, obj) {
					addConditionRow('rowAll', obj);
				});
				
				$.each(resource.anyConditions, function(idx, obj) {
					addConditionRow('rowAny', obj);
				});
				
				$.each(resource.actions, function(idx, obj) {
					obj.newAction = false;
					addActionRow(obj);
				});
				
				$('#tabProperties').parent().append($('#tabConditions').detach());
				$('#tabProperties').parent().append($('#tabActions').detach());
				$('#tabProperties').empty();
				
				$('#tabProperties').propertyPage({
					url : 'triggers/properties/' + resource.id,
					showButtons : false,
					useTemplates : true,
					canUpdate : currentMenu.canUpdate,
					additionalTabs : [ {
						id : "tabConditions",
						name : getResource("tabConditions.label")
					},{
						id : "tabActions",
						name : getResource("tabActions.label")
					}]
				});
				
			},
			validate: function() {
				
				if (!eventAuto.getValue()) {
					$('#addTriggerForm').resourceDialog('error',
							"error.eventRequired");
					return false;
				}
				
				var count = 0;
				$('.editAction').each(function() {
					var a = $(this).data('action');
					if(a) {
						count++;
					}
				});
				
				if(count==0) {
					$('#addTriggerForm').resourceDialog('error',
						"error.atLeastOneActionRequired");
					return false;
				}
				return true;
			},
			createResource: function() {
				resource = new Object();
				resource.id = $('#resourceId').val();
				resource.name = $('#resourceName').val();
				resource.event = eventAuto.getValue();
				resource.result = eventResult.getValue();
				resource.actions = new Array();
				$('.editAction').each(function() {
					var a = $(this).data('action');
					if(a) {
						log("Adding action " + a.name);
						resource.actions.push(a);
					}
				});
				
				$('#tabProperties').saveProperties(true, function(items) {
					resource.properties = items;	
				});
				
				resource.allConditions = new Array();
				
				$('.rowAll').each(function() {
					
					var condition = new Object();
					condition.id = $(this).find('.conditionId').first().val();
					condition.attributeKey = $(this).find('.attributeKey').first().val();
					condition.conditionKey = $(this).find('.conditionKey').first().val();
					condition.conditionValue = $(this).find('.conditionValue').first().val();
					
					log("Adding all condition " + condition.attributeKey + "/" + condition.conditionKey + "=" + condition.conditionValue);
					resource.allConditions.push(condition);
				});
				
				resource.anyConditions = new Array();
				
				$('.rowAny').each(function() {
					var condition = new Object();
					condition.id = $(this).find('.conditionId').first().val();
					condition.attributeKey = $(this).find('.attributeKey').first().val();
					condition.conditionKey = $(this).find('.conditionKey').first().val();
					condition.conditionValue = $(this).find('.conditionValue').first().val();
					
					log("Adding any condition " + condition.attributeKey + "/" + condition.conditionKey + "=" + condition.conditionValue);
					resource.anyConditions.push(condition);
				});
				return resource;
			}
		});
		
		getJSON('triggers/conditions', null, function(data) {
			$('#triggerModal').data('conditions', data.resources);
		});
		
		getJSON('triggers/actions', null, function(data) {
			$('#triggerModal').data('actions', data.resources);
			$('#addActionDropdown').empty();
			$.each(data.resources, function(idx, obj) {
				$('#addActionDropdown').append('<li><a tabindex="-1" href="#" class="editAction" data-value="' + obj + '">' + getResource(obj) + '</a></li>');
			});
			$(".dropdown-toggle").dropdown();
			
			bindActions();
		});
		
		$('#addAll').click(function(e) {
			e.preventDefault();
			addConditionRow('rowAll');
			
			
		});
		
		$('#addAny').click(function(e) {
			e.preventDefault();
			addConditionRow('rowAny');
		});
		
		/**
		 * Fix for stackable modals in Bootstrap 3
		 * http://miles-by-motorcycle.com/static/bootstrap-modal/index.html
		 */
		$('.modal').on('hidden.bs.modal', function(event) {
		    $(this).removeClass( 'fv-modal-stack' );
		    $('body').data( 'fv_open_modals', $('body').data( 'fv_open_modals' ) - 1 );
		});

		$('.modal').on('shown.bs.modal', function (event) {
		       
		   // keep track of the number of open modals
		   if ( typeof( $('body').data('fv_open_modals')) == 'undefined') {
		     $('body').data('fv_open_modals', 0);
		   }
		   
		   // if the z-index of this modal has been set, ignore.         
		    if ($(this).hasClass('fv-modal-stack')) {
		    	return;
		    }
		   
		    $(this).addClass('fv-modal-stack');

		    $('body').data('fv_open_modals', $('body').data('fv_open_modals') + 1);

		    $(this).css('z-index', 1040 + (10 * $('body').data('fv_open_modals')));

		    $('.modal-backdrop').not('.fv-modal-stack' )
		            .css( 'z-index', 1039 + (10 * $('body').data('fv_open_modals')));

		    $('.modal-backdrop').not('fv-modal-stack')
		            .addClass('fv-modal-stack');

		});
	});
</script>